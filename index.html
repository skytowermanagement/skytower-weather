<!doctype html>
<html lang="ja">
<head>
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
  html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
  body { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }

  :root{
    --bg1:#083645;
    --bg2:#0a3f4f;
    --card:#ffffff;
    --muted:#6b7280;
    --line:#e5e7eb;
    --shadow: 0 8px 24px rgba(0,0,0,.18);
    --radius: 18px;

    --hTitle: 38px;
    --hClock: 92px;

    --wDayLabel: 36px;
    --wDate: 30px;
    --wMain: 34px;
    --wSub: 28px;
    --wSmall: 22px;

    --nTitle: 42px;
    --nRowTitle: 36px;
    --nRowMeta: 26px;

    --iconToday: 300px;
    --iconWeek: 80px;

    /* signage fixed size */
    --W: 2160px;
    --H: 785px;
  }

  html, body { width: 100vw; height: 100vh; margin:0; overflow:hidden; }
  body{ display:block; }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: radial-gradient(1400px 900px at 50% -10%, var(--bg2), var(--bg1));
    color:#0f172a;
  }

  #stage{
    position: fixed;
    left: 0; top: 0;
    width: var(--W);
    height: var(--H);
    transform-origin: 0 0;
    overflow: hidden;
  }

  /* ▼▼ “古いデータ” 表示（TTL超え） ▼▼ */
  body.is-stale .card{
    opacity: .58;            /* ここが「薄くする」 */
    filter: saturate(.92);
  }
  body.is-stale .badgeInfo{
    opacity: .95;
  }
  body.is-stale .dot{
    background:#f59e0b;      /* 緑→橙 */
    box-shadow:0 0 0 6px rgba(245,158,11,.20);
  }
  #staleBadge{
    display:none;
    margin-top: 6px;
    background: rgba(245,158,11,.22);
    border: 1px solid rgba(245,158,11,.38);
    color: rgba(255,255,255,.96);
    border-radius: 14px;
    padding: 10px 12px;
    font-weight: 1000;
    font-size: 22px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 920px;
  }
  body.is-stale #staleBadge{ display:block; }
  /* ▲▲ TTL表示ここまで ▲▲ */

  /* ====== layout（下切れ対策：縦方向を少しだけ節約） ====== */
  .wrap{
    width: var(--W);
    height: var(--H);
    padding:14px 20px;     /* 18/22 → 14/20 */
    display:flex;
    flex-direction:column;
    gap:8px;               /* 10 → 8 */
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
  }

  .leftInfo{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:0;
  }

  .badgeInfo{
    display:flex; align-items:center; gap:10px;
    color: rgba(255,255,255,.95);
    font-weight: 900;
    letter-spacing:.5px;
  }
  .dot{ width:10px;height:10px;border-radius:50%; background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.18); }
  #updatedLine{
    color: rgba(255,255,255,.9);
    font-weight: 800;
    font-size: 20px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .alertBar{
    display:none;
    background: rgba(255, 80, 80, .18);
    border: 1px solid rgba(255, 80, 80, .35);
    color: rgba(255,255,255,.95);
    border-radius: 14px;
    padding: 10px 12px;
    font-weight: 900;
    font-size: 22px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 920px;
  }

  /* 防災：カード内表示（白背景に合わせる） */
  .alertInCard{
    max-width: 100%;
    margin: 6px 0 8px;
    background: #fff1f2;
    border: 1px solid #fecdd3;
    color: #9f1239;
    font-size: 20px;
  }

  .clockBox{
    text-align:right;
    color:#fff;
    font-weight:900;
    line-height:1;
    flex:0 0 auto;
  }
  #clockTime{ font-size: var(--hClock); }

  .grid{
    flex:1;
    display:grid;
    grid-template-columns: 0.95fr 1.05fr;
    gap:14px;              /* 16 → 14 */
    min-height:0;
  }

  .card{
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 14px 16px;    /* 16/18 → 14/16 */
    overflow:hidden;
    display:flex;
    flex-direction:column;
    min-height:0;
  }

  .cardHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom: 6px;    /* 8 → 6 */
    gap:10px;
  }
  .cardTitle{
    font-size: var(--hTitle);
    font-weight: 900;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .cardMeta{
    font-size: 20px;
    color: var(--muted);
    font-weight: 800;
    white-space:nowrap;
  }
  .divider{ height:1px; background: var(--line); margin: 6px 0 8px; } /* 8/10 → 6/8 */

  /* ===== Weather ===== */
  .wxBody{ display:flex; flex-direction:column; gap:8px; min-height:0; } /* 10 → 8 */

  .wxTempRow{
    display:flex;
    gap:10px;
    align-items:baseline;
  }
  .wxTempRow > .metricLine{ flex:1; margin:0; }

  .tMax{ color:#dc2626; font-weight:1000; }
  .tMin{ color:#2563eb; font-weight:1000; }

  .wxMetrics{
    font-size: 30px;
    font-weight: 900;
    display:flex;
    flex-direction:column;
    gap:3px;               /* 4 → 3 */
    color:#111827;
  }
  .wxMetrics span{ white-space:nowrap; }
  .wxMetrics .metricLine{ white-space:nowrap; }

  .wxWeekTemps{ font-size: 24px; font-weight: 900; }

  .wxTodayTomorrow{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .wxBox{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 10px 10px 9px;  /* 下を1px詰め */
    min-height: 238px;       /* 245 → 238（下切れ対策） */
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .wxTop{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    font-weight: 900;
    gap:10px;
  }
  .wxLabel{ font-size: var(--wDayLabel); }
  .wxDate{ font-size: var(--wDate); color:#111827; opacity:.95; }

  .wxMid{
    display:grid;
    grid-template-columns: var(--iconToday) 1fr;
    gap: 12px;
    align-items:stretch;
    flex:1;
    min-height:0;
  }
  .wxIconBox{
    width: var(--iconToday);
    height: var(--iconToday);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .wxIcon{ width: 100%; height: 100%; }

  .wxRight{
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    min-width:0;
  }

  .wxText .wxMainWord{
    font-size: 40px;
    font-weight: 1000;
    display:block;
    margin:0 0 4px 0;
  }
  .wxText .wxTail{
    font-size: 28px;
    font-weight: 900;
    opacity: .95;
    display:block;
    line-height: 1.15;     /* 1.18 → 1.15（下切れ対策） */
  }
  .wxText{
    font-weight: 900;
    line-height: 1.10;     /* 1.12 → 1.10 */
    white-space: normal;
    overflow: visible;
    word-break: break-word;
  }

  .wxWeekText{
    font-size: 22px;
    font-weight: 900;
    line-height: 1.10;     /* 1.12 → 1.10 */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
    white-space: normal;
  }
  .wxWeekText .wxMainWord{ font-size: 24px; font-weight: 1000; margin-right: 6px; }
  .wxWeekText .wxTail{ font-size: 20px; font-weight: 900; opacity: .95; }

  .wxText.is-long  .wxTail{ font-size: 24px; }
  .wxText.is-xlong .wxTail{ font-size: 21px; }

  .wxWeek{
    border-top:1px dashed var(--line);
    padding-top: 8px;      /* 10 → 8 */
  }

  .wxWeekRow{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:8px;               /* 10 → 8 */
  }
  .wxWeekItem{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 9px;          /* 10 → 9 */
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:0;
  }
  .wxWeekHead{
    font-weight: 900;
    font-size: 22px;
    color:#111827;
    white-space:nowrap;
  }
  .wxWeekIconBox{
    width: var(--iconWeek);
    height: var(--iconWeek);
    display:flex; align-items:center; justify-content:center;
  }
  .wxWeekIcon{ width:100%; height:100%; }

  /* ===== News ===== */
  .newsBody{
    display:flex;
    flex-direction:column;
    gap:8px;               /* 10 → 8 */
    min-height:0;
  }
  .newsList{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:8px;               /* 10 → 8 */
    overflow:hidden;
  }
  .newsItem{
    border:1px solid var(--line);
    border-radius: 14px;
    padding: 10px 12px;    /* 12 → 10 */
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:0;
  }
  .newsTitle{
    font-size: var(--nRowTitle);
    font-weight: 900;
    line-height:1.12;      /* 1.15 → 1.12（下切れ対策） */
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width: 100%;
  }
  .newsMeta{
    font-size: var(--nRowMeta);
    color: var(--muted);
    font-weight: 800;
    display:flex;
    gap:10px;
    flex-wrap:nowrap;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    min-width:0;
  }

  .chip{
    display:inline-flex;
    align-items:center;
    padding:2px 10px;
    border-radius: 999px;
    font-size: 18px;
    font-weight: 900;
    flex:0 0 auto;
  }
  .chipNational{ background: rgba(37,99,235,.12); color:#1d4ed8; border:1px solid rgba(37,99,235,.25); }
  .chipLocal{ background: rgba(16,185,129,.12); color:#047857; border:1px solid rgba(16,185,129,.25); }

  a{ color:inherit; text-decoration:none; }

  .error{
    background:#fee2e2;
    color:#7f1d1d;
    border:1px solid #fecaca;
    padding:10px 12px;
    border-radius: 12px;
    font-weight: 900;
    white-space:pre-wrap;
  }
</style>
</head>

<body>
  <div id="stage">
    <div class="wrap">
      <div class="topbar">
        <div class="leftInfo">
          <div class="badgeInfo"><span class="dot"></span>Information</div>
          <div id="updatedLine">更新: --</div>
          <div id="staleBadge">前回データ表示中（更新できていません）</div>
          <div id="alertBar" class="alertBar"></div>
        </div>

        <div class="clockBox">
          <div id="clockTime">--:--</div>
        </div>
      </div>

      <div class="grid">
        <!-- Weather -->
        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">天気（江東区 / 東京都地方）</div>
            <div class="cardMeta">気象庁</div>
          </div>

          <div id="alertBarInCard" class="alertBar alertInCard"></div>
          <div id="weatherBody" class="wxBody"></div>
        </div>

        <!-- News -->
        <div class="card">
          <div class="cardHeader">
            <div class="cardTitle">ニュース</div>
          </div>
          <div id="newsBody" class="newsBody"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ★あなたの /exec(B)（固定でOK）
    const WEBAPP_EXEC_URL = "https://script.google.com/macros/s/AKfycbyAlq4IuSKCdpdgV6B6nvRt8-hT5QpNrq-B7ITJvofheIqRCDHf3soudA0fV2CBXLiM/exec";

    // ===== TTL / Cache（ここが今回の肝）=====
    // 例：6時間を超えたら “薄くする” + バッジ表示
    const TTL_MS = 6 * 60 * 60 * 1000; // 6h（必要なら 3h にしてもOK）
    const CACHE_KEY = "SIGNAGE_CACHE_V1";

    // ---------- util ----------
    const pad2 = (n)=> String(n).padStart(2,"0");
    const escapeHtml = (s)=> String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");

    const DOW = ["日","月","火","水","木","金","土"];

    function fmtMDNoZero(dateKey){
      if(!dateKey) return "--/--";
      const [y,m,d] = dateKey.split("-").map(Number);
      return `${m}/${d}`;
    }
    function fmtMDWithDow(dateKey){
      if(!dateKey) return "--/--";
      const dt = new Date(dateKey + "T00:00:00+09:00");
      const md = fmtMDNoZero(dateKey);
      return `${md}（${DOW[dt.getDay()]}）`;
    }
    function fmtTimeHHMM(iso){
      if(!iso) return "--:--";
      const d = new Date(iso);
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function setStaleUi(isStale, msg){
      document.body.classList.toggle("is-stale", !!isStale);
      const badge = document.getElementById("staleBadge");
      if(isStale){
        badge.textContent = msg || "前回データ表示中（更新できていません）";
      }
    }

    function saveCache(payload){
      try{
        localStorage.setItem(CACHE_KEY, JSON.stringify({
          savedAt: Date.now(),
          payload
        }));
      }catch(_){}
    }

    function loadCache(){
      try{
        const t = localStorage.getItem(CACHE_KEY);
        if(!t) return null;
        return JSON.parse(t);
      }catch(_){
        return null;
      }
    }

    function getPayloadTimeMs(payload){
      const g = payload?.generatedAt || payload?.weather?.updatedAt || payload?.news?.updatedAt || null;
      const ms = g ? Date.parse(g) : NaN;
      return Number.isFinite(ms) ? ms : 0;
    }

    // ---------- Weather icon ----------
    function wxKindFromCode(code){
      if(code == null) return "unknown";
      const n = Number(code);
      if(Number.isNaN(n)) return "unknown";
      if(n >= 100 && n < 200) return "sun";
      if(n >= 200 && n < 300) return "cloud";
      if(n >= 300 && n < 400) return "rain";
      if(n >= 400 && n < 500) return "snow";
      return "unknown";
    }
    function wxLabelFromKind(kind){
      if(kind==="sun") return "晴れ";
      if(kind==="cloud") return "くもり";
      if(kind==="rain") return "雨";
      if(kind==="snow") return "雪";
      return "—";
    }

    function splitWxText(raw, kind){
      const t = (raw || "").replace(/\s+/g," ").trim();
      if(!t) return { head: wxLabelFromKind(kind), tail: "" };

      const m = t.match(/^(晴れ|くもり|曇り|雨|雪)(.*)$/);
      if(m){
        const head = (m[1] === "曇り") ? "くもり" : m[1];
        const tail = (m[2] || "").trim();
        return { head, tail };
      }
      const parts = t.split(" ");
      return { head: parts[0], tail: parts.slice(1).join(" ") };
    }

    function wxTextHtml(raw, kind, clsMain="wxMainWord", clsTail="wxTail"){
      const sp = splitWxText(raw, kind);
      const head = sp.head || "—";
      const tail0 = (sp.tail || "").trim();
      const headHtml = `<span class="${clsMain}">${escapeHtml(head)}</span>`;
      if(!tail0) return headHtml;

      const BREAK_RE = /(昼過ぎから|夕方から|夜遅くから|明け方から|朝から|昼前から|夜から)/g;
      const tailWithNL = tail0.replace(BREAK_RE, "\n$1");
      const tailHtml = escapeHtml(tailWithNL).replace(/\n/g, "<br>");

      return `${headHtml}<span class="${clsTail}">${tailHtml}</span>`;
    }

    function wxIconSvg(kind){
      if(kind === "sun"){
        return `
          <svg viewBox="0 0 100 100" width="100%" height="100%">
            <circle cx="50" cy="50" r="18" fill="#f59e0b"></circle>
            ${[0,45,90,135,180,225,270,315].map(a=> {
              const rad = a*Math.PI/180;
              const x1 = 50 + Math.cos(rad)*28, y1 = 50 + Math.sin(rad)*28;
              const x2 = 50 + Math.cos(rad)*42, y2 = 50 + Math.sin(rad)*42;
              return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#f59e0b" stroke-width="6" stroke-linecap="round"></line>`;
            }).join("")}
          </svg>`;
      }
      if(kind === "cloud"){
        return `
          <svg viewBox="-5 -5 150 120" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
            <path d="M35 70c-12 0-22-9-22-20s10-20 22-20c3 0 6 1 9 2C48 22 59 14 73 14c18 0 32 13 34 30 10 2 18 10 18 20 0 12-10 22-22 22H35z"
              fill="#94a3b8"></path>
          </svg>`;
      }
      if(kind === "rain"){
        return `
          <svg viewBox="0 0 120 130" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
            <path d="M35 72c-12 0-22-9-22-20s10-20 22-20c3 0 6 1 9 2C48 24 59 16 73 16c18 0 32 13 34 30 10 2 18 10 18 20 0 12-10 22-22 22H35z"
              fill="#94a3b8"></path>
            ${[40,60,80].map(x=>`<line x1="${x}" y1="86" x2="${x-6}" y2="110" stroke="#3b82f6" stroke-width="6" stroke-linecap="round"></line>`).join("")}
          </svg>`;
      }
      if(kind === "snow"){
        return `
          <svg viewBox="0 0 120 130" width="100%" height="100%" preserveAspectRatio="xMidYMid meet">
            <path d="M35 72c-12 0-22-9-22-20s10-20 22-20c3 0 6 1 9 2C48 24 59 16 73 16c18 0 32 13 34 30 10 2 18 10 18 20 0 12-10 22-22 22H35z"
              fill="#94a3b8"></path>
            ${[44,66,88].map(x=>`<circle cx="${x}" cy="100" r="6" fill="#60a5fa"></circle>`).join("")}
          </svg>`;
      }
      return `
        <svg viewBox="0 0 100 100" width="100%" height="100%">
          <circle cx="50" cy="50" r="40" fill="#e5e7eb"></circle>
          <text x="50" y="62" text-anchor="middle" font-size="54" font-weight="900" fill="#64748b">?</text>
        </svg>`;
    }

    const normDeg = (v) => {
      if (v == null || v === "") return "—";
      return String(v).replace(/°/g, "") + "°";
    };

    function metricLine(label, val, suffix="", cls=""){
      const v = (val == null || val === "") ? "—" : String(val);
      return `<div class="metricLine ${cls}">${label} ${escapeHtml(v)}${suffix}</div>`;
    }

    function renderWxBox(label, day){
      const kind = wxKindFromCode(day?.weatherCode);
      const rawText = (day?.weatherText || "").replace(/\s+/g," ").trim();
      const title = rawText || wxLabelFromKind(kind);

      const minText = normDeg(day?.tempMin);
      const maxText = normDeg(day?.tempMax);
      const len = title.length;
      const textClass =
        (len >= 18) ? "wxText is-xlong" :
        (len >= 13) ? "wxText is-long" :
        "wxText";

      return `
        <div class="wxBox">
          <div class="wxTop">
            <div class="wxLabel">${escapeHtml(label)}</div>
            <div class="wxDate">${fmtMDWithDow(day?.dateKey)}</div>
          </div>

          <div class="wxMid">
            <div class="wxIconBox">
              <div class="wxIcon" title="${escapeHtml(title)}">${wxIconSvg(kind)}</div>
            </div>

            <div class="wxRight">
              <div class="${textClass}" title="${escapeHtml(title)}">
                ${wxTextHtml(rawText, kind, "wxMainWord","wxTail")}
              </div>

              <div class="wxMetrics">
                ${metricLine("最高", maxText, "", "tMax")}
                ${metricLine("最低", minText, "", "tMin")}
                ${metricLine("降水", day?.pop, "%")}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderWeekItem(day){
      const kind = wxKindFromCode(day?.weatherCode);
      const minText = normDeg(day?.tempMin);
      const maxText = normDeg(day?.tempMax);
      const head = fmtMDWithDow(day?.dateKey);

      return `
        <div class="wxWeekItem">
          <div class="wxWeekHead">${head}</div>
          <div class="wxWeekIconBox">
            <div class="wxWeekIcon">${wxIconSvg(kind)}</div>
          </div>
          <div class="wxWeekTemps">
            <span class="tMax">↑${maxText}</span>
            <span class="tMin">↓${minText}</span>
          </div>
        </div>
      `;
    }

    function renderWeather(weather){
      const body = document.getElementById("weatherBody");
      if(!weather || weather.error){
        body.innerHTML = `<div class="error">天気データを取得できません\n${escapeHtml(weather?.error || "")}</div>`;
        return;
      }

      const today = weather.today || {};
      const tomorrow = weather.tomorrow || {};
      let week = Array.isArray(weather.week) ? weather.week : [];

      if (week[0]?.dateKey && weather?.tomorrow?.dateKey && week[0].dateKey === weather.tomorrow.dateKey) {
        week = week.slice(1);
      }
      week = week.slice(0,5);

      body.innerHTML = `
        <div class="wxTodayTomorrow">
          ${renderWxBox("今日", today)}
          ${renderWxBox("明日", tomorrow)}
        </div>

        <div class="wxWeek">
          <div class="wxWeekRow">
            ${week.map(renderWeekItem).join("")}
          </div>
        </div>
      `;
    }

    // ---------- Alerts ----------
    function renderAlerts(alerts){
      const barTop = document.getElementById("alertBar");
      const barCard = document.getElementById("alertBarInCard");

      const hide = (el)=>{ if(!el) return; el.style.display="none"; el.textContent=""; };
      const show = (el, text)=>{ if(!el) return; el.textContent=text; el.style.display="block"; };

      if(!alerts || alerts.length === 0){
        hide(barTop);
        hide(barCard);
        return;
      }
      const text = alerts.slice(0,3).map(a => `【${a.area}】${a.title}`).join(" / ");
      hide(barTop);
      show(barCard, text);
    }

    // ---------- News ----------
    function renderNews(news){
      const body = document.getElementById("newsBody");
      const n = Array.isArray(news?.national) ? news.national : [];
      const l = Array.isArray(news?.local) ? news.local : [];
      const items = [
        ...n.map(x => ({...x, chip:"全国"})),
        ...l.map(x => ({...x, chip:"ローカル"}))
      ];

      if(items.length === 0){
        body.innerHTML = `<div class="error">ニュースを取得できません（RSS）</div>`;
        return;
      }

      body.innerHTML = `
        <ul class="newsList">
          ${items.map(it=>{
            const title = it?.title || "";
            const link = it?.link || "";
            const source = it?.source || "";
            const time = fmtTimeHHMM(it?.time);
            const chip = it?.chip || "";
            const chipClass = (chip==="ローカル") ? "chip chipLocal" : "chip chipNational";

            return `
              <li class="newsItem">
                <div class="newsTitle" title="${escapeHtml(title)}">
                  ${link ? `<a href="${escapeHtml(link)}" target="_blank" rel="noreferrer">${escapeHtml(title)}</a>` : escapeHtml(title)}
                </div>
                <div class="newsMeta" title="${escapeHtml(chip)} / ${escapeHtml(source)} / ${time}">
                  <span class="${chipClass}">${escapeHtml(chip)}</span>
                  <span>${escapeHtml(source)}</span>
                  <span>${time}</span>
                </div>
              </li>
            `;
          }).join("")}
        </ul>
      `;
    }

    // ---------- JSONP ----------
    function loadJsonp(url, cbName, timeoutMs=12000){
      return new Promise((resolve, reject)=>{
        const script = document.createElement("script");
        const timer = setTimeout(()=>{
          cleanup();
          reject(new Error("timeout"));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          script.remove();
          try{ delete window[cbName]; }catch(_){}
        }

        window[cbName] = (data)=>{
          cleanup();
          resolve(data);
        };

        script.onerror = ()=>{
          cleanup();
          reject(new Error("load failed"));
        };

        const sep = url.includes("?") ? "&" : "?";
        script.src = url + sep + "callback=" + encodeURIComponent(cbName) + "&_=" + Date.now();
        document.head.appendChild(script);
      });
    }

    function showDataError(msg, url=""){
      const e = `<div class="error">${escapeHtml(msg)}${url ? "\nURL: " + escapeHtml(url) : ""}</div>`;
      document.getElementById("weatherBody").innerHTML = e;
      document.getElementById("newsBody").innerHTML = e;
    }

    /** =========================
     *  Clock + Refresh
     *  ========================= */
    function tickClock(){
      const now = new Date();
      document.getElementById("clockTime").textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
    }

    function normalizeDateKeys_(payload){
      const w = payload?.weather;
      if (w?.today?.date && !w.today.dateKey) w.today.dateKey = w.today.date;
      if (w?.tomorrow?.date && !w.tomorrow.dateKey) w.tomorrow.dateKey = w.tomorrow.date;
      if (Array.isArray(w?.week)) w.week.forEach(d => { if (d?.date && !d.dateKey) d.dateKey = d.date; });
      return payload;
    }

    function renderPayload_(payload, {fromCache=false} = {}){
      payload = normalizeDateKeys_(payload);

      const generatedAt = payload?.generatedAt || payload?.weather?.updatedAt || null;
      document.getElementById("updatedLine").textContent =
        "更新: " + (generatedAt ? new Date(generatedAt).toLocaleString("ja-JP") : "--");

      renderAlerts(payload?.alerts || []);
      if (payload?.weather) renderWeather(payload.weather);
      else document.getElementById("weatherBody").innerHTML = `<div class="error">天気データが空です</div>`;
      renderNews(payload?.news || { national: [], local: [] });

      // TTL判定 → 薄くする
      const ageMs = Date.now() - getPayloadTimeMs(payload);
      const isStale = (getPayloadTimeMs(payload) > 0) && (ageMs > TTL_MS);

      if(fromCache){
        setStaleUi(true, isStale
          ? "前回データ表示中（古い可能性があります）"
          : "前回データ表示中（通信待ち）"
        );
      }else{
        setStaleUi(isStale, isStale ? "更新が止まっています（古い可能性があります）" : "");
      }
    }

    async function refresh(){
      // 1) GAS内プレビューなら google.script.run が最優先
      if (window.google?.script?.run?.withSuccessHandler) {
        google.script.run
          .withSuccessHandler((payload)=>{
            saveCache(payload);
            renderPayload_(payload, {fromCache:false});
          })
          .withFailureHandler((err)=>{
            // 失敗→キャッシュを表示（薄くする）
            const c = loadCache();
            if(c?.payload){
              renderPayload_(c.payload, {fromCache:true});
            }else{
              showDataError("データ取得エラー: " + (err?.message || String(err)));
              setStaleUi(true, "更新できていません（キャッシュ無し）");
            }
          })
          .getData();
        return;
      }

      // 2) 外部（CYBER Signage等）なら JSONP
      const execUrl = WEBAPP_EXEC_URL;
      if (!execUrl) {
        showDataError("WEBAPP_EXEC_URL が未設定です。/exec URL を設定してください。");
        return;
      }
      const dataUrl = execUrl + (execUrl.includes("?") ? "&" : "?") + "mode=data";

      try{
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const payload = await loadJsonp(dataUrl, cbName);

        saveCache(payload);
        renderPayload_(payload, {fromCache:false});

      }catch(err){
        // ★ここが重要：真っ白にせず「前回表示を残す」＋「薄くする」
        const c = loadCache();
        if(c?.payload){
          renderPayload_(c.payload, {fromCache:true});
        }else{
          showDataError("データ取得エラー: " + (err?.message || String(err)), dataUrl);
          setStaleUi(true, "更新できていません（キャッシュ無し）");
        }
      }
    }

    tickClock();
    setInterval(tickClock, 1000 * 5);
    refresh();
    setInterval(refresh, 1000 * 60 * 2);
  </script>

  <script>
  (function(){
    const DESIGN_W = 2160;
    const DESIGN_H = 785;
    const stage = document.getElementById("stage");

    function fit(){
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const scale = Math.min(vw / DESIGN_W, vh / DESIGN_H);
      stage.style.transform = `scale(${scale})`;
    }

    window.addEventListener("resize", fit);
    fit();
  })();
  </script>

</body>
</html>
