<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

  <style>
    html, body {
      width: 1380px;
      height: 776px;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #ffffff;
      color: #111827;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP",
                   "Segoe UI", Roboto, "Helvetica Neue", Arial, "Yu Gothic", sans-serif;
    }
    #app{
      width: 1380px;
      height: 776px;
      box-sizing: border-box;
      padding: 28px 34px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 18px;
    }
    .top{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
    }
    .title{
      font-size: 46px;
      font-weight: 900;
      letter-spacing: 0.02em;
      line-height: 1.1;
    }
    .meta{
      font-size: 22px;
      opacity: 0.75;
      white-space: nowrap;
    }
    .cards{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      min-height: 0;
    }
    .card{
      border-radius: 24px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 22px 26px;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 10px;
      min-height: 0;
    }
    .card h2{
      margin: 0;
      font-size: 36px;
      font-weight: 900;
    }
    .wxline{
      display: flex;
      align-items: center;
      gap: 14px;
      margin-top: 2px;
      min-width: 0;
    }
    .icon{
      width: 64px;
      height: 64px;
      flex: 0 0 64px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #111827;
    }
    .icon svg{ width:64px; height:64px; display:block; }
    .wxtext{
      font-size: 32px;
      font-weight: 800;
      opacity: 0.95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }
    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-content: start;
    }
    .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      font-size: 28px;
      line-height: 1.2;
    }
    .label{ opacity: 0.75; }
    .val{ font-weight: 900; }

    .footer{
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      opacity: 0.7;
      white-space: nowrap;
      gap: 16px;
    }
    #dbg{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  </style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">東京（江東区）天気</div>
      <div class="meta" id="pub">更新：--</div>
    </div>

    <div class="cards">
      <section class="card">
        <h2>今日</h2>
        <div class="wxline">
          <span class="icon" id="i0"></span>
          <span class="wxtext" id="w0">--</span>
        </div>
        <div class="grid">
          <div class="row"><span class="label">最高 / 最低</span><span class="val" id="t0">-- / -- ℃</span></div>
          <div class="row"><span class="label">降水確率（0-6/6-12/12-18/18-24）</span><span class="val" id="p0">--</span></div>
        </div>
      </section>

      <section class="card">
        <h2>明日</h2>
        <div class="wxline">
          <span class="icon" id="i1"></span>
          <span class="wxtext" id="w1">--</span>
        </div>
        <div class="grid">
          <div class="row"><span class="label">最高 / 最低</span><span class="val" id="t1">-- / -- ℃</span></div>
          <div class="row"><span class="label">降水確率（0-6/6-12/12-18/18-24）</span><span class="val" id="p1">--</span></div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>出典：気象庁（forecast JSON）</div>
      <div id="dbg"></div>
      <div id="err"></div>
    </div>
  </div>

  <script>
    // --- SVGアイコン（外部読込ゼロ） ---
    const ICONS = {
      sun: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round">
            <circle cx="32" cy="32" r="10"></circle>
            <path d="M32 6v8"></path><path d="M32 50v8"></path>
            <path d="M6 32h8"></path><path d="M50 32h8"></path>
            <path d="M13 13l6 6"></path><path d="M45 45l6 6"></path>
            <path d="M51 13l-6 6"></path><path d="M19 45l-6 6"></path>
          </g>
        </svg>`,
      cloud: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 46h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 30a8 8 0 0 0 2 16z"></path>
          </g>
        </svg>`,
      rain: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M24 46v8"></path><path d="M34 46v8"></path><path d="M44 46v8"></path>
          </g>
        </svg>`,
      snow: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M24 49l4 4m0-4l-4 4"></path>
            <path d="M34 49l4 4m0-4l-4 4"></path>
            <path d="M44 49l4 4m0-4l-4 4"></path>
          </g>
        </svg>`,
      mix: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M26 46v8"></path>
            <path d="M38 49l4 4m0-4l-4 4"></path>
            <path d="M48 46v8"></path>
          </g>
        </svg>`,
      thunder: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M34 42l-8 12h8l-4 8 12-16h-8l4-4z"></path>
          </g>
        </svg>`
    };

    function iconKeyFromJmaCode(code){
      if (code == null || isNaN(code)) return "cloud";
      const c = Number(code);
      const h = Math.floor(c / 100);
      if (h === 1) return "sun";
      if (h === 2) return "cloud";
      if (h === 3) return "rain";
      if (h === 4) return "snow";
      if (h === 5) return "mix";
      return "cloud";
    }
    function setIcon(elId, code){
      const key = iconKeyFromJmaCode(code);
      const el = document.getElementById(elId);
      el.innerHTML = ICONS[key] || ICONS.cloud;
    }

    function pad2(n){ return String(n).padStart(2, "0"); }
    function dateKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

    function addDaysKey(baseKey, add){
      const [y,m,dd] = baseKey.split("-").map(Number);
      const d = new Date(y, m-1, dd);
      d.setDate(d.getDate() + add);
      return dateKey(d);
    }

    function findAreaIndex(ts, wantedName){
      if (!ts?.areas?.length) return -1;
      let idx = ts.areas.findIndex(a => a.area?.name === wantedName);
      if (idx >= 0) return idx;
      idx = ts.areas.findIndex(a => (a.area?.name || "").includes(wantedName));
      if (idx >= 0) return idx;
      idx = ts.areas.findIndex(a => (a.area?.name || "").includes("東京"));
      return idx;
    }

    // timeDefines + values から「日付ごとの 0-6/6-12/12-18/18-24」の4枠に詰める
    function buildPopsByDay(timeDefines, pops){
      const map = {};
      for (let i=0; i<Math.min(timeDefines.length, pops.length); i++){
        const t = new Date(timeDefines[i]);
        const key = dateKey(t);
        const h = t.getHours();
        const slot = (h < 6) ? 0 : (h < 12) ? 1 : (h < 18) ? 2 : 3;
        if (!map[key]) map[key] = ["--","--","--","--"];
        const v = (pops[i] === "" || pops[i] == null) ? "--" : pops[i];
        map[key][slot] = v;
      }
      return map;
    }

    function fmtPops4(arr){
      if (!arr) return "--";
      return arr.join(" / ");
    }

    // tempsMax/tempsMin を「日付単位」にする
    function buildTempsByDay(timeDefines, tempsMax, tempsMin){
      const map = {};
      for (let i=0; i<timeDefines.length; i++){
        const t = new Date(timeDefines[i]);
        const key = dateKey(t);
        const max = tempsMax?.[i];
        const min = tempsMin?.[i];
        if (!map[key]) map[key] = {max: null, min: null};
        if (max != null && max !== "") map[key].max = max;
        if (min != null && min !== "") map[key].min = min;
      }
      return map;
    }

    function fmtTemp(max, min){
      return `${max ?? "--"} / ${min ?? "--"} ℃`;
    }

    async function main(){
      const errEl = document.getElementById("err");
      const dbgEl = document.getElementById("dbg");
      errEl.textContent = "";
      dbgEl.textContent = "";

      try{
        const url = "https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json";
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch failed: ${res.status}`);
        const data = await res.json();

        // 今日/明日 キー（ローカル日付）
        const todayKey = dateKey(new Date());
        const tomoKey  = addDaysKey(todayKey, 1);

        // ====== 天気 & 降水（だいたい data[0]）======
        const d0 = data?.[0];
        const pub = (d0?.reportDatetime || "").replace("T"," ").slice(0,16);
        document.getElementById("pub").textContent = pub ? `更新：${pub}` : "更新：--";

        const tsList0 = d0?.timeSeries || [];
        const tsW = tsList0[0]; // weathers / weatherCodes
        const tsP = tsList0[1]; // pops (timeDefinesあり)

        // 江東区は「東京地方」扱い
        const AREA_NAME = "東京地方";

        // 天気
        const iw = findAreaIndex(tsW, AREA_NAME);
        const weatherCodes = (iw >= 0 ? tsW.areas[iw].weatherCodes : []) || [];
        const weathers     = (iw >= 0 ? tsW.areas[iw].weathers : []) || [];

        document.getElementById("w0").textContent = weathers[0] || "--";
        document.getElementById("w1").textContent = weathers[1] || "--";
        setIcon("i0", weatherCodes[0]);
        setIcon("i1", weatherCodes[1]);

        // 降水確率（timeDefinesから4枠に詰める）
        let popsByDay = {};
        if (tsP?.timeDefines?.length){
          const ip = findAreaIndex(tsP, AREA_NAME);
          const pops = (ip >= 0 ? tsP.areas[ip].pops : []) || [];
          popsByDay = buildPopsByDay(tsP.timeDefines, pops);
        }
        document.getElementById("p0").textContent = fmtPops4(popsByDay[todayKey]);
        document.getElementById("p1").textContent = fmtPops4(popsByDay[tomoKey]);

        // ====== 気温（多くは data[1] 側）======
        const d1 = data?.[1];
        let max0=null, min0=null, max1=null, min1=null;

        if (d1?.timeSeries?.length){
          // tempsMax/tempsMin を持つ timeSeries を探す
          const tsTemp = d1.timeSeries.find(ts =>
            ts?.areas?.some(a => a.tempsMax || a.tempsMin)
          );

          if (tsTemp?.timeDefines?.length){
            const it = findAreaIndex(tsTemp, AREA_NAME);
            const a = (it >= 0 ? tsTemp.areas[it] : null);

            // どっちかのキーが無い場合もあるので保険
            const tempsMax = a?.tempsMax || [];
            const tempsMin = a?.tempsMin || [];

            const tmap = buildTempsByDay(tsTemp.timeDefines, tempsMax, tempsMin);
            max0 = tmap[todayKey]?.max ?? null;
            min0 = tmap[todayKey]?.min ?? null;
            max1 = tmap[tomoKey]?.max ?? null;
            min1 = tmap[tomoKey]?.min ?? null;
          }
        }

        document.getElementById("t0").textContent = fmtTemp(max0, min0);
        document.getElementById("t1").textContent = fmtTemp(max1, min1);

        // デバッグ表示（必要なら後で消す）
        dbgEl.textContent =
          `area=${AREA_NAME} / popsKeys=${Object.keys(popsByDay).join(",")} / today=${todayKey}`;

        // 30分ごと自動更新
        setTimeout(() => location.reload(), 30 * 60 * 1000);

      }catch(e){
        errEl.textContent = `表示エラー：${e.message || e}`;
      }
    }

    main();
  </script>
</body>
</html>
