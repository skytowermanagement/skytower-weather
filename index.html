<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

  <style>
    html, body{
      width:1380px; height:776px;
      margin:0; padding:0;
      overflow:hidden;
      background:#fff;
      color:#111;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP","Segoe UI",Roboto,"Helvetica Neue",Arial,"Yu Gothic",sans-serif;
    }

    #app{
      width:1380px; height:776px;
      box-sizing:border-box;
      padding:34px 44px;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:18px;
    }

    .top{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:18px;
    }
    .title{
      font-size:60px;
      font-weight:900;
      letter-spacing:0.02em;
      line-height:1.05;
    }
    .meta{
      font-size:28px;
      opacity:0.85;
      white-space:nowrap;
    }

    .cards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:22px;
      min-height:0;
    }

    .card{
      border-radius:26px;
      background:#f3f5f7;
      border:1px solid rgba(0,0,0,0.08);
      padding:26px 30px;
      display:grid;
      grid-template-rows:auto auto 1fr;
      gap:14px;
      min-height:0;
    }

    .card h2{
      margin:0;
      font-size:48px;
      font-weight:900;
      letter-spacing:0.01em;
    }

    .wx{
      display:flex;
      align-items:center;
      gap:14px;
      font-size:42px;   /* â†å¤©æ°—æ–‡å­—ã‚’å¤§ãã */
      font-weight:900;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .icon{
      font-size:64px;   /* â†ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤§ãã */
      line-height:1;
      transform:translateY(2px);
    }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
      align-content:start;
    }

    .row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:18px;
      font-size:34px;   /* â†é …ç›®æ–‡å­—ã‚’å¤§ãã */
      line-height:1.15;
    }

    .label{ opacity:0.75; }
    .val{ font-weight:900; }

    .footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:20px;
      opacity:0.7;
      white-space:nowrap;
    }

    *{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  </style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">æ±äº¬ï¼ˆæ±Ÿæ±åŒºï¼‰å¤©æ°—</div>
      <div class="meta" id="pub">æ›´æ–°ï¼š--</div>
    </div>

    <div class="cards">
      <section class="card">
        <h2>ä»Šæ—¥</h2>
        <div class="wx"><span class="icon" id="i0">--</span><span id="w0">--</span></div>
        <div class="grid">
          <div class="row"><span class="label">æœ€é«˜ / æœ€ä½</span><span class="val" id="t0">-- / -- â„ƒ</span></div>
          <div class="row"><span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span><span class="val" id="p0">--/--/--/--</span></div>
        </div>
      </section>

      <section class="card">
        <h2>æ˜æ—¥</h2>
        <div class="wx"><span class="icon" id="i1">--</span><span id="w1">--</span></div>
        <div class="grid">
          <div class="row"><span class="label">æœ€é«˜ / æœ€ä½</span><span class="val" id="t1">-- / -- â„ƒ</span></div>
          <div class="row"><span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span><span class="val" id="p1">--/--/--/--</span></div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>å‡ºå…¸ï¼šæ°—è±¡åºï¼ˆforecast JSONï¼‰</div>
      <div id="err"></div>
    </div>
  </div>

<script>
(async () => {
  const $ = (id) => document.getElementById(id);
  const AREA_WEATHER_KEY = "æ±äº¬"; // "æ±äº¬åœ°æ–¹" ç­‰ã‚’å«ã‚€ã®ã§ includes ã§æ‹¾ã†

  function parseJst(s){
    // "2026-01-14T17:00:00+09:00" ãªã©
    return new Date(s);
  }
  function ymd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function pickArea(ts, keyword){
    if (!ts?.areas?.length) return null;
    const i = ts.areas.findIndex(a => (a?.area?.name || "").includes(keyword));
    return ts.areas[i >= 0 ? i : 0];
  }

  // å¤©æ°—æ–‡è¨€â†’çµµæ–‡å­—ï¼ˆã–ã£ãã‚Šã§OKã€‚å¿…è¦ãªã‚‰è¿½åŠ ï¼‰
  function iconFromWeatherText(t){
    const s = (t || "");
    if (s.includes("æ™´")) return "â˜€ï¸";
    if (s.includes("ãã‚‚ã‚Š") || s.includes("æ›‡")) return "â˜ï¸";
    if (s.includes("é›¨")) return "ğŸŒ§ï¸";
    if (s.includes("é›ª")) return "â„ï¸";
    if (s.includes("é›·")) return "â›ˆï¸";
    return "ğŸŒ¤ï¸";
  }

  // pops ã‚’ timeDefines ã®æ™‚åˆ»ã§ 0-6/6-12/12-18/18-24 ã«å‰²ã‚Šå½“ã¦
  function popsBySlots(tsPop, keyword, dateStr){
    const a = pickArea(tsPop, keyword);
    if (!a) return ["--","--","--","--"];

    const pops = a.pops || [];
    const tds = tsPop.timeDefines || [];
    const out = ["--","--","--","--"];

    for (let i=0; i<tds.length; i++){
      const d = parseJst(tds[i]);
      if (ymd(d) !== dateStr) continue;
      const h = d.getHours();
      const slot = (h < 6) ? 0 : (h < 12) ? 1 : (h < 18) ? 2 : 3;
      out[slot] = (pops[i] ?? "--");
    }
    return out;
  }

  // é€±é–“äºˆå ±ã‹ã‚‰ max/min ã‚’å¼•ãï¼ˆä»Šæ—¥ãŒæ¬ ã‘ã¦ã‚‚å¿…ãšå‡ºã™ç”¨ï¼‰
  function tempsFromWeekly(data1, keyword, dateStr){
    const d1 = data1;
    if (!d1?.timeSeries?.length) return null;

    const ts = d1.timeSeries.find(x => x?.areas?.[0]?.tempsMin && x?.areas?.[0]?.tempsMax);
    if (!ts) return null;

    const a = pickArea(ts, keyword) || ts.areas[0];
    const mins = a.tempsMin || [];
    const maxs = a.tempsMax || [];
    const i = (ts.timeDefines || []).findIndex(td => ymd(parseJst(td)) === dateStr);
    if (i < 0) return null;

    const min = mins[i] ?? "--";
    const max = maxs[i] ?? "--";
    if (min === "--" && max === "--") return null;
    return {min, max};
  }

  try{
    const url = "https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json";
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("fetch failed: " + res.status);
    const data = await res.json();

    const d0 = data[0]; // è©³ç´°ï¼ˆå¤©æ°—/é™æ°´/æ°—æ¸©ï¼‰
    const d1 = data[1]; // é€±é–“ï¼ˆæ°—æ¸©è£œå®Œã«ä½¿ã†ï¼‰

    // æ›´æ–°æ™‚åˆ»
    const rep = (d0.reportDatetime || "--").replace("T"," ").slice(0,16);
    $("pub").textContent = "æ›´æ–°ï¼š" + rep;

    const today = new Date();
    const tomo  = new Date(Date.now() + 24*60*60*1000);
    const todayStr = ymd(today);
    const tomoStr  = ymd(tomo);

    // å¤©æ°—ï¼ˆä»Šæ—¥/æ˜æ—¥ï¼‰
    const tsW = d0.timeSeries?.[0];
    const aW = pickArea(tsW, AREA_WEATHER_KEY);
    const weathers = aW?.weathers || [];
    const w0 = weathers[0] ?? "--";
    const w1 = weathers[1] ?? (weathers[0] ?? "--"); // å¿µã®ãŸã‚

    $("w0").textContent = w0;
    $("w1").textContent = w1;
    $("i0").textContent = iconFromWeatherText(w0);
    $("i1").textContent = iconFromWeatherText(w1);

    // é™æ°´ç¢ºç‡ï¼ˆ4æ ï¼‰
    const tsP = d0.timeSeries?.[1];
    const p0 = popsBySlots(tsP, AREA_WEATHER_KEY, todayStr);
    const p1 = popsBySlots(tsP, AREA_WEATHER_KEY, tomoStr);
    $("p0").textContent = p0.join("/");
    $("p1").textContent = p1.join("/");

    // æ°—æ¸©ï¼ˆä»Šæ—¥/æ˜æ—¥ï¼‰â†’ é€±é–“ã§å¿…ãšè£œå®Œ
    const t0w = tempsFromWeekly(d1, AREA_WEATHER_KEY, todayStr);
    const t1w = tempsFromWeekly(d1, AREA_WEATHER_KEY, tomoStr);

    $("t0").textContent = (t0w ? `${t0w.max} / ${t0w.min} â„ƒ` : "-- / -- â„ƒ");
    $("t1").textContent = (t1w ? `${t1w.max} / ${t1w.min} â„ƒ` : "-- / -- â„ƒ");

    // 30åˆ†æ›´æ–°ï¼ˆã‚µã‚¤ãƒãƒ¼ã‚¸å‘ã‘ï¼‰
    setTimeout(() => location.reload(), 30 * 60 * 1000);

  }catch(e){
    $("err").textContent = "è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ï¼š" + (e?.message || e);
  }
})();
</script>

</body>
</html>
