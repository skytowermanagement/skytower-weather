<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

  <style>
    html, body {
      width: 1380px;
      height: 776px;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #0b0f14;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Yu Gothic", sans-serif;
    }

    #app {
      width: 1380px;
      height: 776px;
      box-sizing: border-box;
      padding: 28px 34px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 18px;
    }

    .top {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
    }

    .title {
      font-size: 44px;
      font-weight: 800;
      letter-spacing: 0.02em;
      line-height: 1.1;
    }

    .meta {
      font-size: 22px;
      opacity: 0.8;
      white-space: nowrap;
    }

    .cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      min-height: 0;
    }

    .card {
      border-radius: 22px;
      background: rgba(255,255,255,0.08);
      padding: 22px 26px;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 10px;
      min-height: 0;
    }

    .card h2 {
      margin: 0;
      font-size: 34px;
      font-weight: 800;
    }

    .wx {
      font-size: 30px;
      font-weight: 700;
      opacity: 0.95;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-content: start;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      font-size: 28px;
      line-height: 1.2;
    }

    .label { opacity: 0.75; }
    .val   { font-weight: 800; }

    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      opacity: 0.75;
      white-space: nowrap;
    }

    #err { color: #ffb3b3; }

    * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  </style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">東京（江東区）天気</div>
      <div class="meta" id="pub">更新：--</div>
    </div>

    <div class="cards">
      <section class="card">
        <h2>今日</h2>
        <div class="wx" id="w0">--</div>
        <div class="grid">
          <div class="row"><span class="label">最高 / 最低</span><span class="val" id="t0">-- / -- ℃</span></div>
          <div class="row"><span class="label">降水確率（0-6/6-12/12-18/18-24）</span><span class="val" id="p0">--</span></div>
        </div>
      </section>

      <section class="card">
        <h2>明日</h2>
        <div class="wx" id="w1">--</div>
        <div class="grid">
          <div class="row"><span class="label">最高 / 最低</span><span class="val" id="t1">-- / -- ℃</span></div>
          <div class="row"><span class="label">降水確率（0-6/6-12/12-18/18-24）</span><span class="val" id="p1">--</span></div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>出典：気象庁（forecast JSON）</div>
      <div id="err"></div>
    </div>
  </div>

  <script>
    (async () => {
      const errEl = document.getElementById("err");
      const setErr = (msg) => { errEl.textContent = msg || ""; };

      try {
        // 東京都（東京地方 = 江東区含む扱い）
        const url = "https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json";
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("fetch failed: " + res.status);
        const data = await res.json();

        // 更新時刻
        const pub = (data?.[0]?.reportDatetime || "").replace("T", " ").slice(0, 16);
        document.getElementById("pub").textContent = pub ? `更新：${pub}` : "更新：--";

        // --- 天気（今日/明日） ---
        // timeSeries内のどれかに weatherCodes / weathers がある
        const tsWeather = (data?.[0]?.timeSeries || []).find(ts =>
          ts?.areas?.[0]?.weatherCodes || ts?.areas?.[0]?.weathers
        );
        if (!tsWeather) throw new Error("天気データが見つかりません");

        // 「東京地方」を優先。なければ先頭
        const areaWeather =
          tsWeather.areas.find(a => a.area?.name?.includes("東京")) || tsWeather.areas[0];

        const weatherTexts = areaWeather.weathers || [];
        const weatherCodes = areaWeather.weatherCodes || [];

        // 表示は “今日=0, 明日=1” を基本（取得形式により足りない場合あり）
        const w0 = weatherTexts[0] || (weatherCodes[0] ? `天気コード:${weatherCodes[0]}` : "--");
        const w1 = weatherTexts[1] || (weatherCodes[1] ? `天気コード:${weatherCodes[1]}` : "--");
        document.getElementById("w0").textContent = w0;
        document.getElementById("w1").textContent = w1;

        // --- 降水確率（6時間ごと） ---
        const tsPop = (data?.[0]?.timeSeries || []).find(ts => ts?.areas?.[0]?.pops);
        if (tsPop) {
          const areaPop =
            tsPop.areas.find(a => a.area?.name?.includes("東京")) || tsPop.areas[0];
          const pops = (areaPop.pops || []).map(x => (x === "" ? "--" : x));

          const todayP = pops.slice(0, 4).join(" / ");
          const tomoP  = pops.slice(4, 8).join(" / ");

          document.getElementById("p0").textContent = todayP || "--";
          document.getElementById("p1").textContent = tomoP  || "--";
        } else {
          document.getElementById("p0").textContent = "--";
          document.getElementById("p1").textContent = "--";
        }

        // --- 気温（最高/最低） ---
        // 気象庁の形式は揺れるので「tempsがあるts」を探して日ごとにmax/minを推定
        const tsTemp = (data?.[0]?.timeSeries || []).find(ts => ts?.areas?.[0]?.temps);
        if (tsTemp) {
          const areaTemp =
            tsTemp.areas.find(a => a.area?.name?.includes("東京")) || tsTemp.areas[0];

          const times = tsTemp.timeDefines || [];
          const temps = (areaTemp.temps || []).map(t => (t === "" ? null : Number(t)));

          // 日付(YYYY-MM-DD)ごとに集計
          const byDate = new Map();
          for (let i = 0; i < Math.min(times.length, temps.length); i++) {
            const d = (times[i] || "").slice(0, 10);
            const v = temps[i];
            if (!d || v == null || Number.isNaN(v)) continue;
            if (!byDate.has(d)) byDate.set(d, []);
            byDate.get(d).push(v);
          }

          const dates = Array.from(byDate.keys()).sort(); // 今日→明日の順になりやすい
          const today = dates[0];
          const tomo  = dates[1];

          const fmt = (arr) => {
            if (!arr || !arr.length) return "-- / -- ℃";
            const max = Math.max(...arr);
            const min = Math.min(...arr);
            return `${max} / ${min} ℃`;
          };

          document.getElementById("t0").textContent = fmt(byDate.get(today));
          document.getElementById("t1").textContent = fmt(byDate.get(tomo));
        } else {
          document.getElementById("t0").textContent = "-- / -- ℃";
          document.getElementById("t1").textContent = "-- / -- ℃";
        }

        // 30分ごとに自動更新（サイネージ向け）
        setTimeout(() => location.reload(), 30 * 60 * 1000);

        setErr("");
      } catch (e) {
        setErr("表示エラー：" + (e?.message || e));
      }
    })();
  </script>
</body>
</html>
