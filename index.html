<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

  <style>
    html, body{
      width:1380px; height:776px;
      margin:0; padding:0;
      overflow:hidden;
      background:#fff;
      color:#111;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP","Segoe UI",Roboto,"Helvetica Neue",Arial,"Yu Gothic",sans-serif;
    }

    #app{
      width:1380px; height:776px;
      box-sizing:border-box;
      padding:34px 44px;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:18px;
    }

    .top{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:18px;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ã¯å°ã•ãã¦è‰¯ã„ */
    .title{
      font-size:40px;
      font-weight:900;
      letter-spacing:0.02em;
      line-height:1.05;
    }

    .meta{
      font-size:26px;
      opacity:0.85;
      white-space:nowrap;
    }

    .cards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:22px;
      min-height:0;
    }

    .card{
      border-radius:26px;
      background:#f3f5f7;
      border:1px solid rgba(0,0,0,0.08);
      padding:26px 30px;
      display:grid;
      grid-template-rows:auto auto 1fr;
      gap:16px;
      min-height:0;
    }

    .card h2{
      margin:0;
      font-size:56px;
      font-weight:900;
      letter-spacing:0.01em;
    }

    .wx{
      display:flex;
      align-items:center;
      gap:20px;
      font-size:46px;
      font-weight:900;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ãƒãƒ¼ã‚¯ã‚’â€œ6å€ç´šâ€ã§ãƒ‰ã‚«ãƒ³ã¨ */
    .icon{
      font-size:180px; /* â†ã“ã“ãŒè‚ï¼ˆã•ã‚‰ã«å¢—ã‚„ã—ãŸã‘ã‚Œã° 200/220 ã¸ï¼‰ */
      line-height:1;
      transform:translateY(6px);
      flex:0 0 auto;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
      align-content:start;
    }

    .row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:18px;
      font-size:36px;
      line-height:1.15;
    }

    .label{
      opacity:0.75;
      white-space:nowrap;
    }

    /* å€¤ãŒæŠ˜ã‚Šè¿”ã—ã¦å´©ã‚Œã‚‹ã®ã‚’é˜²ã */
    .val{
      font-weight:900;
      white-space:nowrap;
      text-align:right;
    }

    .footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:18px;
      opacity:0.7;
      white-space:nowrap;
    }

    *{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  </style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">æ±äº¬ï¼ˆæ±Ÿæ±åŒºï¼‰å¤©æ°—</div>
      <div class="meta" id="pub">æ›´æ–°ï¼š--</div>
    </div>

    <div class="cards">
      <section class="card">
        <h2>ä»Šæ—¥</h2>
        <div class="wx"><span class="icon" id="i0">--</span><span id="w0">--</span></div>
        <div class="grid">
          <div class="row"><span class="label">æœ€é«˜ / æœ€ä½</span><span class="val" id="t0">-- / -- â„ƒ</span></div>
          <div class="row"><span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span><span class="val" id="p0">--/--/--/--</span></div>
        </div>
      </section>

      <section class="card">
        <h2>æ˜æ—¥</h2>
        <div class="wx"><span class="icon" id="i1">--</span><span id="w1">--</span></div>
        <div class="grid">
          <div class="row"><span class="label">æœ€é«˜ / æœ€ä½</span><span class="val" id="t1">-- / -- â„ƒ</span></div>
          <div class="row"><span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span><span class="val" id="p1">--/--/--/--</span></div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>å‡ºå…¸ï¼šæ°—è±¡åºï¼ˆforecast JSONï¼‰</div>
      <div id="err"></div>
    </div>
  </div>

<script>
(async () => {
  const $ = (id) => document.getElementById(id);
  const AREA_KEY = "æ±äº¬"; // ã¾ãšã¯ã“ã‚Œã§ã€‚ãƒ€ãƒ¡ãªã‚‰ä¸‹ã®ã€Œæ±äº¬åœ°æ–¹ã€ã«å¤‰ãˆã‚‹

  function parseJst(s){ return new Date(s); }
  function ymd(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function pickArea(ts, keyword){
    if (!ts?.areas?.length) return null;
    const i = ts.areas.findIndex(a => (a?.area?.name || "").includes(keyword));
    return ts.areas[i >= 0 ? i : 0];
  }

  function iconFromWeatherText(t){
    const s = (t || "");
    if (s.includes("æ™´")) return "â˜€ï¸";
    if (s.includes("ãã‚‚ã‚Š") || s.includes("æ›‡")) return "â˜ï¸";
    if (s.includes("é›¨")) return "ğŸŒ§ï¸";
    if (s.includes("é›ª")) return "â„ï¸";
    if (s.includes("é›·")) return "â›ˆï¸";
    return "ğŸŒ¤ï¸";
  }

  function pad4(arr){
    const a = (arr || []).slice(0,4);
    while(a.length<4) a.push("--");
    return a;
  }

  // âœ… é™æ°´ç¢ºç‡ï¼šæœ€çŸ­ï¼†å®‰å®šï¼ˆå…ˆé ­4=ä»Šæ—¥ã€æ¬¡ã®4=æ˜æ—¥ï¼‰
  function popsTodayTomorrow(d0){
    const tsP = d0.timeSeries?.[1];
    const aP  = pickArea(tsP, AREA_KEY);
    const pops = (aP?.pops || []).map(x => (x==="" ? "--" : x));
    const today = pad4(pops.slice(0,4));
    const tomo  = pad4(pops.slice(4,8));
    return {today, tomo};
  }

  // âœ… ä»Šæ—¥ã®æœ€é«˜/æœ€ä½ï¼šdata[0] ã® temps æ™‚ç³»åˆ—ã‹ã‚‰æ—¥åˆ¥max/minã‚’è¨ˆç®—
  function tempsFromD0(d0){
    const tsTemp = (d0.timeSeries || []).find(ts => ts?.areas?.[0]?.temps && ts?.timeDefines);
    if (!tsTemp) return null;

    const a = pickArea(tsTemp, AREA_KEY);
    if (!a) return null;

    const times = tsTemp.timeDefines || [];
    const temps = a.temps || [];

    const byDate = new Map(); // dateStr -> [temps...]
    for (let i=0; i<times.length; i++){
      const v = temps[i];
      if (v === "" || v == null) continue;
      const n = Number(v);
      if (!Number.isFinite(n)) continue;
      const d = ymd(parseJst(times[i]));
      if (!byDate.has(d)) byDate.set(d, []);
      byDate.get(d).push(n);
    }

    const todayStr = ymd(new Date());
    const tomoStr  = ymd(new Date(Date.now()+24*60*60*1000));

    function get(dateStr){
      const arr = byDate.get(dateStr);
      if (!arr || !arr.length) return null;
      return { max: Math.max(...arr), min: Math.min(...arr) };
    }

    return { today: get(todayStr), tomo: get(tomoStr) };
  }

  try{
    const url = "https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json";
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("fetch failed: " + res.status);
    const data = await res.json();

    const d0 = data[0];

    const rep = (d0.reportDatetime || "--").replace("T"," ").slice(0,16);
    $("pub").textContent = "æ›´æ–°ï¼š" + rep;

    // å¤©æ°—
    const tsW = d0.timeSeries?.[0];
    const aW = pickArea(tsW, AREA_KEY);
    const weathers = aW?.weathers || [];
    const w0 = weathers[0] ?? "--";
    const w1 = weathers[1] ?? "--";
    $("w0").textContent = w0;
    $("w1").textContent = w1;
    $("i0").textContent = iconFromWeatherText(w0);
    $("i1").textContent = iconFromWeatherText(w1);

    // é™æ°´ç¢ºç‡ï¼ˆå®‰å®šã‚¹ãƒ©ã‚¤ã‚¹ï¼‰
    const pops = popsTodayTomorrow(d0);
    $("p0").textContent = pops.today.join("/");
    $("p1").textContent = pops.tomo.join("/");

    // æ°—æ¸©ï¼ˆä»Šæ—¥/æ˜æ—¥ï¼‰
    const t = tempsFromD0(d0);
    if (t?.today) $("t0").textContent = `${t.today.max} / ${t.today.min} â„ƒ`;
    else          $("t0").textContent = `-- / -- â„ƒ`;

    if (t?.tomo)  $("t1").textContent = `${t.tomo.max} / ${t.tomo.min} â„ƒ`;
    else          $("t1").textContent = `-- / -- â„ƒ`;

    // 30åˆ†æ›´æ–°
    setTimeout(() => location.reload(), 30 * 60 * 1000);

  }catch(e){
    $("err").textContent = "è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ï¼š" + (e?.message || e);
  }
})();
</script>

</body>
</html>
