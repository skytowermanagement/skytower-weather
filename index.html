<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

  <style>
    html, body {
      width: 1380px;
      height: 776px;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #ffffff;
      color: #111827;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP",
                   "Segoe UI", Roboto, "Helvetica Neue", Arial, "Yu Gothic", sans-serif;
    }

    #app{
      width: 1380px;
      height: 776px;
      box-sizing: border-box;
      padding: 28px 34px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 18px;
    }

    .top{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
    }

    .title{
      font-size: 46px;
      font-weight: 900;
      letter-spacing: 0.02em;
      line-height: 1.1;
    }

    .meta{
      font-size: 22px;
      opacity: 0.75;
      white-space: nowrap;
    }

    .cards{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      min-height: 0;
    }

    .card{
      border-radius: 24px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 22px 26px;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 10px;
      min-height: 0;
    }

    .card h2{
      margin: 0;
      font-size: 36px;
      font-weight: 900;
    }

    /* ここが「アイコン＋天気文字」行 */
    .wxline{
      display: flex;
      align-items: center;
      gap: 14px;
      margin-top: 2px;
      min-width: 0;
    }

    .icon{
      width: 64px;
      height: 64px;
      flex: 0 0 64px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #111827; /* SVGは currentColor で描画 */
    }

    .icon svg{
      width: 64px;
      height: 64px;
      display: block;
    }

    .wxtext{
      font-size: 32px;
      font-weight: 800;
      opacity: 0.95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-content: start;
    }

    .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      font-size: 28px;
      line-height: 1.2;
    }

    .label{ opacity: 0.75; }
    .val{ font-weight: 900; }

    .footer{
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      opacity: 0.7;
      white-space: nowrap;
    }

    *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  </style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">東京（江東区）天気</div>
      <div class="meta" id="pub">更新：--</div>
    </div>

    <div class="cards">
      <section class="card">
        <h2>今日</h2>
        <div class="wxline">
          <span class="icon" id="i0"></span>
          <span class="wxtext" id="w0">--</span>
        </div>
        <div class="grid">
          <div class="row"><span class="label">最高 / 最低</span><span class="val" id="t0">-- / -- ℃</span></div>
          <div class="row"><span class="label">降水確率（0-6/6-12/12-18/18-24）</span><span class="val" id="p0">--</span></div>
        </div>
      </section>

      <section class="card">
        <h2>明日</h2>
        <div class="wxline">
          <span class="icon" id="i1"></span>
          <span class="wxtext" id="w1">--</span>
        </div>
        <div class="grid">
          <div class="row"><span class="label">最高 / 最低</span><span class="val" id="t1">-- / -- ℃</span></div>
          <div class="row"><span class="label">降水確率（0-6/6-12/12-18/18-24）</span><span class="val" id="p1">--</span></div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>出典：気象庁（forecast JSON）</div>
      <div id="err"></div>
    </div>
  </div>

  <script>
    // --- SVGアイコン（外部読込ゼロ） ---
    const ICONS = {
      sun: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round">
            <circle cx="32" cy="32" r="10"></circle>
            <path d="M32 6v8"></path><path d="M32 50v8"></path>
            <path d="M6 32h8"></path><path d="M50 32h8"></path>
            <path d="M13 13l6 6"></path><path d="M45 45l6 6"></path>
            <path d="M51 13l-6 6"></path><path d="M19 45l-6 6"></path>
          </g>
        </svg>`,
      cloud: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 46h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 30a8 8 0 0 0 2 16z"></path>
          </g>
        </svg>`,
      rain: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M24 46v8"></path><path d="M34 46v8"></path><path d="M44 46v8"></path>
          </g>
        </svg>`,
      snow: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M24 49l4 4m0-4l-4 4"></path>
            <path d="M34 49l4 4m0-4l-4 4"></path>
            <path d="M44 49l4 4m0-4l-4 4"></path>
          </g>
        </svg>`,
      mix: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M26 46v8"></path>
            <path d="M38 49l4 4m0-4l-4 4"></path>
            <path d="M48 46v8"></path>
          </g>
        </svg>`,
      thunder: `
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 38h26a10 10 0 0 0 0-20h-1.2A14 14 0 0 0 20 22a8 8 0 0 0 2 16z"></path>
            <path d="M34 42l-8 12h8l-4 8 12-16h-8l4-4z"></path>
          </g>
        </svg>`
    };

    // JMA天気コード→ざっくりカテゴリ（必要なら後で精密化）
    function iconKeyFromJmaCode(code){
      if (code == null || isNaN(code)) return "cloud";
      // JMAの多くは 1xx=晴系, 2xx=くもり系, 3xx=雨系, 4xx=雪系, 5xx=雨雪/雷など が多い
      const c = Number(code);
      const h = Math.floor(c / 100);
      if (h === 1) return "sun";
      if (h === 2) return "cloud";
      if (h === 3) return "rain";
      if (h === 4) return "snow";
      if (h === 5) return "mix";
      return "cloud";
    }

    function setIcon(elId, code){
      const key = iconKeyFromJmaCode(code);
      const el = document.getElementById(elId);
      el.innerHTML = ICONS[key] || ICONS.cloud;
      el.title = String(code ?? "");
    }

    function fmtTemp(max, min){
      const a = (max ?? "--");
      const b = (min ?? "--");
      return `${a} / ${b} ℃`;
    }

    function fmtPops(arr4){
      if (!arr4 || !arr4.length) return "--";
      return arr4.map(x => (x === "" ? "--" : x)).join(" / ");
    }

    function findAreaIndex(ts, wantedName){
      if (!ts?.areas?.length) return -1;
      // まず完全一致→なければ含むで拾う
      let idx = ts.areas.findIndex(a => a.area?.name === wantedName);
      if (idx >= 0) return idx;
      idx = ts.areas.findIndex(a => (a.area?.name || "").includes(wantedName));
      if (idx >= 0) return idx;
      // 最後の保険：東京を含む
      idx = ts.areas.findIndex(a => (a.area?.name || "").includes("東京"));
      return idx;
    }

    async function main(){
      const errEl = document.getElementById("err");
      errEl.textContent = "";

      try{
        // 東京(130000)
        const url = "https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json";
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch failed: ${res.status}`);
        const data = await res.json();

        // 更新時刻
        const pub = (data?.[0]?.reportDatetime || "").replace("T"," ").slice(0,16);
        document.getElementById("pub").textContent = pub ? `更新：${pub}` : "更新：--";

        const tsList = data?.[0]?.timeSeries || [];
        const tsW  = tsList[0]; // weatherCodes / weathers
        const tsP  = tsList[1]; // pops
        const tsT  = tsList[2]; // temps (地域によっては無い場合も)

        // 江東区=東京地方扱い（必要ならここだけ変える）
        const AREA_NAME = "東京地方";

        // --- 天気（今日/明日） ---
        const iw = findAreaIndex(tsW, AREA_NAME);
        const weatherCodes = (iw >= 0 ? tsW.areas[iw].weatherCodes : []) || [];
        const weathers     = (iw >= 0 ? tsW.areas[iw].weathers : []) || [];

        // 0:今日, 1:明日（データ欠ける場合あり）
        const code0 = weatherCodes[0];
        const code1 = weatherCodes[1];

        document.getElementById("w0").textContent = weathers[0] || "--";
        document.getElementById("w1").textContent = weathers[1] || "--";
        setIcon("i0", code0);
        setIcon("i1", code1);

        // --- 降水確率（4区分） ---
        const ip = findAreaIndex(tsP, AREA_NAME);
        const pops = (ip >= 0 ? tsP.areas[ip].pops : []) || [];

        // popsは「時間が並ぶ」ので、先頭4つ=今日(0-6/6-12/12-18/18-24)、次の4つ=明日
        const todayP = pops.slice(0,4);
        const tomoP  = pops.slice(4,8);

        document.getElementById("p0").textContent = fmtPops(todayP);
        document.getElementById("p1").textContent = fmtPops(tomoP);

        // --- 気温（最高/最低） ---
        // tsTがない/形式が違う場合があるので保険付き
        let max0=null, min0=null, max1=null, min1=null;

        if (tsT?.areas?.length){
          const it = findAreaIndex(tsT, AREA_NAME);
          const temps = (it >= 0 ? tsT.areas[it].temps : []) || [];
          // 気象庁JSONは地域によって並びが違うことがあるので、まず2個/4個を想定で拾う
          // ありがち: [今日の最高, 今日の最低, 明日の最高, 明日の最低] or 近い形
          if (temps.length >= 4){
            max0 = temps[0]; min0 = temps[1];
            max1 = temps[2]; min1 = temps[3];
          }else{
            // 足りない時は "--" のまま
          }
        }

        document.getElementById("t0").textContent = fmtTemp(max0, min0);
        document.getElementById("t1").textContent = fmtTemp(max1, min1);

        // サイネージ用：30分ごとに自動更新
        setTimeout(() => location.reload(), 30 * 60 * 1000);

      }catch(e){
        document.getElementById("err").textContent = `表示エラー：${e.message || e}`;
      }
    }

    main();
  </script>
</body>
</html>
