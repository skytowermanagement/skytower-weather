<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

  <style>
    /* ===== å›ºå®šã‚µã‚¤ã‚ºï¼ˆæ¨ª1380 ç¸¦776ï¼‰ ===== */
    html, body {
      width: 1380px;
      height: 776px;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #ffffff; /* â† èƒŒæ™¯ ç™½ */
      color: #111;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP",
                   "Segoe UI", Roboto, "Helvetica Neue", Arial, "Yu Gothic", sans-serif;
    }

    /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    #app{
      width: 1380px;
      height: 776px;
      box-sizing: border-box;
      padding: 28px 34px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 18px;
    }

    /* ä¸Šéƒ¨ */
    .top{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
    }
    .title{
      font-size: 44px;   /* â†ã“ã“ã¯å°ã•ãã¦OKã¨ã®ã“ã¨ãªã®ã§éå‰°ã«å¤§ããã—ãªã„ */
      font-weight: 900;
      letter-spacing: 0.02em;
      line-height: 1.05;
    }
    .meta{
      font-size: 22px;
      opacity: 0.8;
      white-space: nowrap;
    }

    /* ã‚«ãƒ¼ãƒ‰2æš */
    .cards{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      min-height: 0;
    }
    .card{
      border-radius: 22px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 26px 26px;
      display: grid;
      grid-template-rows: auto auto auto 1fr;
      gap: 10px;
      min-height: 0;
    }
    .card h2{
      margin: 0;
      font-size: 48px;
      font-weight: 900;
      letter-spacing: 0.02em;
    }

    /* ===== ã‚¢ã‚¤ã‚³ãƒ³è¶…å·¨å¤§ + å¤©æ°—çŸ­æ–‡ ===== */
    .wxline{
      display:flex;
      align-items:center;
      gap: 24px;
      min-height: 340px; /* â†ã‚¢ã‚¤ã‚³ãƒ³å·¨å¤§ç”¨ã®é«˜ã•ç¢ºä¿ */
    }
    .icon{
      font-size: 420px;  /* â†ã€Œã•ã‚‰ã«3å€ã€ç›¸å½“ã®å·¨å¤§åŒ–ï¼ˆå¿…è¦ãªã‚‰ã“ã“ã ã‘å¢—ã‚„ã™ï¼‰ */
      line-height: 1;
      width: 520px;
      text-align: left;
    }
    .wxtext{
      font-size: 96px;
      font-weight: 900;
      letter-spacing: 0.02em;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 740px;
    }

    /* é•·æ–‡ï¼ˆæœã‹ã‚‰ã€œç­‰ï¼‰ã¯åˆ¥è¡Œã§2è¡Œã¾ã§ */
    .wxdetail{
      margin-top: -6px;
      font-size: 44px;
      font-weight: 800;
      opacity: 0.9;
      line-height: 1.18;

      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2; /* 2è¡Œã§ã‚«ãƒƒãƒˆ */
      overflow: hidden;
    }

    /* æ•°å€¤è¡Œ */
    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-content: start;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      font-size: 34px;   /* â†æ–‡å­—ã‚‚å¤§ãã */
      line-height: 1.2;
    }
    .label{ opacity: 0.75; }
    .val{ font-weight: 900; }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer{
      display:flex;
      justify-content: space-between;
      align-items:center;
      font-size: 18px;
      opacity: 0.75;
      white-space: nowrap;
      gap: 16px;
    }
    #err{
      font-weight: 800;
      color: #b91c1c;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 980px;
    }

    *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  </style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">æ±äº¬ï¼ˆæ±Ÿæ±åŒºï¼‰å¤©æ°—</div>
      <div class="meta" id="pub">æ›´æ–°ï¼š--</div>
    </div>

    <div class="cards">
      <!-- ä»Šæ—¥ -->
      <section class="card">
        <h2>ä»Šæ—¥</h2>

        <div class="wxline">
          <div class="icon" id="i0">--</div>
          <div class="wxtext" id="w0">--</div>
        </div>
        <div class="wxdetail" id="d0">--</div>

        <div class="grid">
          <div class="row">
            <span class="label">æœ€é«˜ / æœ€ä½</span>
            <span class="val" id="t0">-- / -- â„ƒ</span>
          </div>
          <div class="row">
            <span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span>
            <span class="val" id="p0">--/--/--/--</span>
          </div>
        </div>
      </section>

      <!-- æ˜æ—¥ -->
      <section class="card">
        <h2>æ˜æ—¥</h2>

        <div class="wxline">
          <div class="icon" id="i1">--</div>
          <div class="wxtext" id="w1">--</div>
        </div>
        <div class="wxdetail" id="d1">--</div>

        <div class="grid">
          <div class="row">
            <span class="label">æœ€é«˜ / æœ€ä½</span>
            <span class="val" id="t1">-- / -- â„ƒ</span>
          </div>
          <div class="row">
            <span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span>
            <span class="val" id="p1">--/--/--/--</span>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>å‡ºå…¸ï¼šæ°—è±¡åºï¼ˆforecast JSONï¼‰</div>
      <div id="err"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function jstDateKey(d){
      // JSTåŸºæº–ã§ YYYY-MM-DD ã‚’ä½œã‚‹
      const z = new Date(d.toLocaleString("en-US", { timeZone: "Asia/Tokyo" }));
      const y = z.getFullYear();
      const m = String(z.getMonth()+1).padStart(2,"0");
      const da = String(z.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    function toKeyFromISO(iso){
      // "2026-01-14T05:00:00+09:00" -> "2026-01-14"
      return (iso || "").slice(0,10);
    }

    function pickArea(areas, preferNames){
      if (!Array.isArray(areas)) return null;
      // 1) å„ªå…ˆãƒ¯ãƒ¼ãƒ‰ã«åˆã†ã‚‚ã®
      for (const kw of preferNames){
        const hit = areas.find(a => (a?.area?.name || "").includes(kw));
        if (hit) return hit;
      }
      // 2) æ±äº¬ãŒå…¥ã‚‹ã‚‚ã®
      const tokyo = areas.find(a => (a?.area?.name || "").includes("æ±äº¬"));
      if (tokyo) return tokyo;
      // 3) å…ˆé ­
      return areas[0] || null;
    }

    function shortWx(text){
      const t = (text || "").replace(/\s+/g," ").trim();
      const m = t.match(/(æ™´ã‚Œ|ãã‚‚ã‚Š|æ›‡ã‚Š|é›¨|é›ª|ã¿ãã‚Œ|é›·)/);
      if (!m) return t ? t.slice(0,6) : "--";
      return (m[1] === "æ›‡ã‚Š") ? "ãã‚‚ã‚Š" : m[1];
    }

    function iconFromWx(text, code){
      // code ãŒã‚ã‚Œã°ãã‚Œå„ªå…ˆï¼ˆæ°—è±¡åºã®å¤©æ°—ã‚³ãƒ¼ãƒ‰ã¯å¤šã„ã®ã§ã–ã£ãã‚Šåˆ†é¡ï¼‰
      const c = String(code || "");
      if (c.startsWith("1")) return "â˜€ï¸"; // å¿«æ™´/æ™´ã‚Œç³»ãŒå¤šã„
      if (c.startsWith("2")) return "â›…ï¸";
      if (c.startsWith("3")) return "â˜ï¸";
      if (c.startsWith("4")) return "ğŸŒ§ï¸";
      if (c.startsWith("5")) return "ğŸŒ¨ï¸";
      if (c.startsWith("6")) return "â›ˆï¸";

      // code ãŒç„¡ã„ã¨ãã¯æ–‡å­—ã‹ã‚‰æ¨å®š
      const s = (text || "");
      if (s.includes("é›ª")) return "ğŸŒ¨ï¸";
      if (s.includes("é›·")) return "â›ˆï¸";
      if (s.includes("é›¨")) return "ğŸŒ§ï¸";
      if (s.includes("ãã‚‚ã‚Š") || s.includes("æ›‡")) return "â˜ï¸";
      if (s.includes("æ™´")) return "â˜€ï¸";
      return "â›…ï¸";
    }

    function setErr(msg){
      $("err").textContent = msg || "";
    }

    async function main(){
      try{
        setErr("");

        const res = await fetch("https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch failed: ${res.status}`);
        const json = await res.json();
        const root = json?.[0];
        if (!root) throw new Error("JSON structure unexpected");

        // æ›´æ–°æ™‚åˆ»
        const report = root.reportDatetime ? root.reportDatetime.slice(0,16).replace("T"," ") : "--";
        $("pub").textContent = `æ›´æ–°ï¼š${report}`;

        const todayKey = jstDateKey(new Date());
        const tomoKey  = jstDateKey(new Date(Date.now() + 24*60*60*1000));

        const ts = root.timeSeries || [];

        // ---- (A) å¤©æ°—ï¼ˆweathers / weatherCodesï¼‰ ----
        const wxTS = ts.find(x => Array.isArray(x?.areas) && (x.areas[0]?.weathers || x.areas[0]?.weatherCodes));
        if (!wxTS) throw new Error("weather timeSeries not found");
        const wxArea = pickArea(wxTS.areas, ["æ±äº¬åœ°æ–¹", "æ±äº¬"]);
        const wxTimes = (wxTS.timeDefines || []).map(toKeyFromISO);

        const wxByDate = new Map();
        wxTimes.forEach((k, idx) => {
          const w = wxArea?.weathers?.[idx];
          const c = wxArea?.weatherCodes?.[idx];
          if (k && (w || c)) wxByDate.set(k, { w, c });
        });

        const wToday = wxByDate.get(todayKey)?.w || "--";
        const cToday = wxByDate.get(todayKey)?.c;
        const wTomo  = wxByDate.get(tomoKey)?.w || "--";
        const cTomo  = wxByDate.get(tomoKey)?.c;

        $("i0").textContent = iconFromWx(wToday, cToday);
        $("w0").textContent = shortWx(wToday);
        $("d0").textContent = (wToday || "--").replace(/\s+/g," ").trim();

        $("i1").textContent = iconFromWx(wTomo, cTomo);
        $("w1").textContent = shortWx(wTomo);
        $("d1").textContent = (wTomo || "--").replace(/\s+/g," ").trim();

        // ---- (B) é™æ°´ç¢ºç‡ï¼ˆpopsï¼‰ ----
        const popTS = ts.find(x => Array.isArray(x?.areas) && x.areas[0]?.pops);
        const popArea = popTS ? pickArea(popTS.areas, ["æ±äº¬åœ°æ–¹", "æ±äº¬"]) : null;
        const popTimes = (popTS?.timeDefines || []).map(toKeyFromISO);

        function popsForDate(dateKey){
          // 0-6/6-12/12-18/18-24 ã®4ã¤ã‚’é›†ã‚ã‚‹ï¼ˆåŒæ—¥ã®4æ ï¼‰
          const out = [];
          for (let i=0; i<popTimes.length; i++){
            if (popTimes[i] === dateKey){
              const v = popArea?.pops?.[i];
              out.push((v === "" || v == null) ? "--" : String(v));
            }
          }
          // 4å€‹ã«æº€ãŸãªã„ã¨ãã¯åŸ‹ã‚ã‚‹
          while (out.length < 4) out.push("--");
          return out.slice(0,4).join("/");
        }

        $("p0").textContent = popTS ? popsForDate(todayKey) : "--/--/--/--";
        $("p1").textContent = popTS ? popsForDate(tomoKey)  : "--/--/--/--";

        // ---- (C) æ°—æ¸©ï¼ˆtempsï¼šæœ€é«˜/æœ€ä½ï¼‰ ----
        const tempTS = ts.find(x => Array.isArray(x?.areas) && x.areas[0]?.temps);
        const tempArea = tempTS ? pickArea(tempTS.areas, ["æ±äº¬", "æ±äº¬åœ°æ–¹"]) : null;
        const tempTimes = (tempTS?.timeDefines || []).map(toKeyFromISO);

        function tempHiLo(dateKey){
          // temps ã¯ã€Œæœ€ä½/æœ€é«˜ã€é †ã‚„æ—¥è·¨ããŒæ··ã–ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€
          // åŒæ—¥ã®å€¤ã‚’æ‹¾ã£ã¦ max/min ã‚’ä½œã‚‹ï¼ˆç©ºã¯é™¤å¤–ï¼‰
          const vals = [];
          for (let i=0; i<tempTimes.length; i++){
            if (tempTimes[i] === dateKey){
              const v = tempArea?.temps?.[i];
              const n = (v === "" || v == null) ? NaN : Number(v);
              if (!Number.isNaN(n)) vals.push(n);
            }
          }
          if (!vals.length) return { hi: "--", lo: "--" };
          const hi = Math.max(...vals);
          const lo = Math.min(...vals);
          return { hi: String(hi), lo: String(lo) };
        }

        const t0 = tempTS ? tempHiLo(todayKey) : {hi:"--", lo:"--"};
        const t1 = tempTS ? tempHiLo(tomoKey)  : {hi:"--", lo:"--"};

        $("t0").textContent = `${t0.hi} / ${t0.lo} â„ƒ`;
        $("t1").textContent = `${t1.hi} / ${t1.lo} â„ƒ`;

        // 30åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆã‚µã‚¤ãƒãƒ¼ã‚¸å‘ã‘ï¼‰
        setTimeout(() => location.reload(), 30 * 60 * 1000);

      }catch(e){
        setErr(`è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ï¼š${e?.message || e}`);
      }
    }

    main();
  </script>
</body>
</html>
