<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <!-- ã‚µã‚¤ãƒãƒ¼ã‚¸æƒ³å®šï¼šå›ºå®šã‚µã‚¤ã‚ºã§æç”» -->
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

  <style>
    html, body{
      width: 1380px;
      height: 776px;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #ffffff;
      color: #111827;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Yu Gothic", sans-serif;
    }

    /* å·¦å³ãŒåˆ‡ã‚Œã‚„ã™ã„ç’°å¢ƒãŒã‚ã‚‹ã®ã§ã‚»ãƒ¼ãƒ•ãƒãƒ¼ã‚¸ãƒ³ã‚’åºƒã‚ã« */
    #app{
      width: 1380px;
      height: 776px;
      box-sizing: border-box;
      padding: 26px 56px;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 16px;
    }

    .top{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ«ã¯å°ã•ã‚ã§OKã¨ã®ã“ã¨ãªã®ã§æŠ‘ãˆã‚‹ */
    .title{
      font-size: 40px;
      font-weight: 900;
      letter-spacing: 0.01em;
      line-height: 1.1;
    }

    .meta{
      font-size: 22px;
      font-weight: 700;
      opacity: 0.75;
      white-space: nowrap;
    }

    .cards{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      min-height: 0;
    }

    .card{
      border-radius: 22px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 22px 24px;
      display: grid;
      grid-template-rows: auto auto auto auto 1fr;
      gap: 10px;
      min-height: 0;
    }

    .card h2{
      margin: 0;
      font-size: 46px;
      font-weight: 900;
      letter-spacing: 0.02em;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ + â€œæ™´ã‚Œâ€ ãªã©ï¼ˆçµ¶å¯¾ã«åã‚ã‚‹ï¼‰ */
    .wxline{
      display: flex;
      align-items: center;
      gap: 18px;
      min-height: 0;
      margin-top: 2px;
    }

    .icon{
      font-size: 220px;      /* å¤§ãã„ãŒãƒ‡ã‚«éããªã„ */
      line-height: 1;
      width: 260px;
      text-align: center;
      flex: 0 0 260px;
    }

    .wxtext{
      font-size: 84px;
      font-weight: 900;
      letter-spacing: 0.02em;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 420px;
    }

    /* â€œæ™´ã‚Œ æœã‹ã‚‰ æ˜¼éã ãã‚‚ã‚Šâ€ ãªã©ã¯2è¡Œã§åã‚ã‚‹ */
    .wxdetail{
      font-size: 34px;
      font-weight: 800;
      opacity: 0.9;
      line-height: 1.22;

      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
      min-height: calc(34px * 1.22 * 2); /* 2è¡Œåˆ†ã‚’ç¢ºä¿ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®‰å®š */
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      align-content: start;
      margin-top: 2px;
    }

    .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      font-size: 34px;
      line-height: 1.2;
    }

    .label{ opacity: 0.75; font-weight: 800; }
    .val{ font-weight: 900; }

    .footer{
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      opacity: 0.65;
      white-space: nowrap;
      gap: 16px;
    }

    #dbg{
      font-size: 14px;
      opacity: 0.5;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 980px;
    }

    #err{
      color: #b91c1c;
      font-weight: 800;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 420px;
    }

    *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  </style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">æ±äº¬ï¼ˆæ±Ÿæ±åŒºï¼‰å¤©æ°—</div>
      <div class="meta" id="pub">æ›´æ–°ï¼š--</div>
    </div>

    <div class="cards">
      <!-- ä»Šæ—¥ -->
      <section class="card">
        <h2>ä»Šæ—¥</h2>

        <div class="wxline">
          <div class="icon" id="i0">--</div>
          <div class="wxtext" id="s0">--</div>
        </div>

        <div class="wxdetail" id="d0">--</div>

        <div class="grid">
          <div class="row">
            <span class="label">æœ€é«˜ / æœ€ä½</span>
            <span class="val" id="t0">-- / -- â„ƒ</span>
          </div>
          <div class="row">
            <span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span>
            <span class="val" id="p0">--</span>
          </div>
        </div>
      </section>

      <!-- æ˜æ—¥ -->
      <section class="card">
        <h2>æ˜æ—¥</h2>

        <div class="wxline">
          <div class="icon" id="i1">--</div>
          <div class="wxtext" id="s1">--</div>
        </div>

        <div class="wxdetail" id="d1">--</div>

        <div class="grid">
          <div class="row">
            <span class="label">æœ€é«˜ / æœ€ä½</span>
            <span class="val" id="t1">-- / -- â„ƒ</span>
          </div>
          <div class="row">
            <span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span>
            <span class="val" id="p1">--</span>
          </div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>å‡ºå…¸ï¼šæ°—è±¡åºï¼ˆforecast JSONï¼‰</div>
      <div id="dbg"></div>
      <div id="err"></div>
    </div>
  </div>

  <script>
    const URL_JMA = "https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json";

    const el = (id) => document.getElementById(id);
    const setErr = (msg) => (el("err").textContent = msg || "");
    const setDbg = (msg) => (el("dbg").textContent = msg || "");

    const fmtDateKey = (iso) => {
      // "2026-01-14T00:00:00+09:00" -> "2026-01-14"
      if (!iso) return "";
      return String(iso).slice(0, 10);
    };

    const iconFromText = (t) => {
      const s = (t || "").toLowerCase();
      // å„ªå…ˆé †ä½ï¼šé›· > é›ª > é›¨ > æ™´ > ãã‚‚ã‚Š
      if (s.includes("é›·") || s.includes("ã‹ã¿ãªã‚Š") || s.includes("é›·é›¨")) return "â›ˆï¸";
      if (s.includes("é›ª") || s.includes("ã¿ãã‚Œ")) return "â„ï¸";
      if (s.includes("é›¨") || s.includes("ã‚ã‚")) return "ğŸŒ§ï¸";
      if (s.includes("æ™´") || s.includes("ã¯ã‚Œ")) return "â˜€ï¸";
      if (s.includes("ãã‚‚") || s.includes("æ›‡")) return "â˜ï¸";
      return "ğŸŒ¤ï¸";
    };

    const shortWx = (t) => {
      const s = (t || "").trim();
      // å…ˆé ­ã« â€œæ™´ã‚Œâ€ â€œãã‚‚ã‚Šâ€ â€œé›¨â€ â€œé›ªâ€ ãŒå«ã¾ã‚Œã¦ã‚‹å‰æã§çŸ­ç¸®
      // ä¾‹: "æ™´ã‚Œã€€æœã€€ã‹ã‚‰ã€€æ˜¼éãã€€ãã‚‚ã‚Š" -> "æ™´ã‚Œ"
      // ä¾‹: "ãã‚‚ã‚Šã€€æ™‚ã€…ã€€é›¨" -> "ãã‚‚ã‚Š"
      const m = s.match(/^(æ™´ã‚Œ|ãã‚‚ã‚Š|æ›‡ã‚Š|é›¨|é›ª|é›·)/);
      if (m) return m[1].replace("æ›‡ã‚Š","ãã‚‚ã‚Š");
      // ãƒ€ãƒ¡ãªã‚‰æœ€åˆã®å˜èª
      return s.split(/[ ã€€]/).filter(Boolean)[0] || s || "--";
    };

    function pickAreaIndex(ts, preferName){
      if (!ts || !ts.areas) return 0;
      const a = ts.areas;
      const idx = a.findIndex(x => (x.area && x.area.name && x.area.name.includes(preferName)));
      return idx >= 0 ? idx : 0;
    }

    function buildByDate(times, values){
      // times[] ã¨ values[] ã‚’æ—¥ä»˜ã‚­ãƒ¼ã§ã¾ã¨ã‚ã‚‹
      const by = {};
      for (let i = 0; i < Math.min(times.length, values.length); i++){
        const k = fmtDateKey(times[i]);
        if (!k) continue;
        if (!by[k]) by[k] = [];
        by[k].push(values[i]);
      }
      return by;
    }

    function maxMinFromTemps(list){
      const nums = (list || [])
        .map(x => Number(x))
        .filter(n => Number.isFinite(n));
      if (!nums.length) return {max:null, min:null};
      return {max: Math.max(...nums), min: Math.min(...nums)};
    }

    async function main(){
      setErr("");
      setDbg("");

      const res = await fetch(URL_JMA, { cache: "no-store" });
      if (!res.ok) throw new Error("fetch failed: " + res.status);

      const json = await res.json();
      const data = Array.isArray(json) ? json[0] : json;
      if (!data || !data.timeSeries) throw new Error("unexpected JSON");

      // æ›´æ–°æ™‚åˆ»
      const pub = data.reportDatetime || data.publicTime || "";
      el("pub").textContent = pub ? ("æ›´æ–°ï¼š" + pub.slice(0,16).replace("T"," ")) : "æ›´æ–°ï¼š--";

      const tsList = data.timeSeries || [];

      // ---- å¤©æ°—ï¼ˆæ–‡ç« ï¼‰ ----
      const tsWeather = tsList.find(ts => ts.areas && ts.areas[0] && ts.areas[0].weathers) || tsList[0];
      const areaWeatherIdx = pickAreaIndex(tsWeather, "æ±äº¬åœ°æ–¹");
      const wTimes = (tsWeather.timeDefines || []);
      const wVals = (tsWeather.areas && tsWeather.areas[areaWeatherIdx] && tsWeather.areas[areaWeatherIdx].weathers) ? tsWeather.areas[areaWeatherIdx].weathers : [];
      const wByDate = buildByDate(wTimes, wVals);

      // ---- é™æ°´ç¢ºç‡ ----
      const tsPop = tsList.find(ts => ts.areas && ts.areas[0] && ts.areas[0].pops);
      const areaPopIdx = tsPop ? pickAreaIndex(tsPop, "æ±äº¬åœ°æ–¹") : 0;
      const pTimes = tsPop ? (tsPop.timeDefines || []) : [];
      const pVals = tsPop && tsPop.areas && tsPop.areas[areaPopIdx] ? (tsPop.areas[areaPopIdx].pops || []) : [];
      const pByDate = buildByDate(pTimes, pVals);

      // ---- æ°—æ¸© ----
      const tsTemp = tsList.find(ts => ts.areas && ts.areas[0] && ts.areas[0].temps);
      const areaTempIdx = tsTemp ? pickAreaIndex(tsTemp, "æ±äº¬åœ°æ–¹") : 0;
      const tTimes = tsTemp ? (tsTemp.timeDefines || []) : [];
      const tVals = tsTemp && tsTemp.areas && tsTemp.areas[areaTempIdx] ? (tsTemp.areas[areaTempIdx].temps || []) : [];
      const tByDate = buildByDate(tTimes, tVals);

      // ä»Šæ—¥/æ˜æ—¥ã‚­ãƒ¼
      // reportDatetimeãŒå–ã‚Œã‚Œã°ãã‚Œã‚’åŸºæº–ã€ãªã‘ã‚Œã°å¤©æ°—ã®æœ€åˆã®æ—¥ä»˜
      const baseKey = fmtDateKey(data.reportDatetime) || fmtDateKey(wTimes[0]) || fmtDateKey(pTimes[0]) || fmtDateKey(tTimes[0]);
      if (!baseKey) throw new Error("date key not found");

      const d0 = new Date(baseKey + "T00:00:00+09:00");
      const d1 = new Date(d0); d1.setDate(d0.getDate() + 1);
      const key0 = d0.toISOString().slice(0,10);
      const key1 = d1.toISOString().slice(0,10);

      // è¡¨ç¤ºï¼šå¤©æ°—
      const w0full = (wByDate[key0] && wByDate[key0][0]) ? wByDate[key0][0] : (wVals[0] || "--");
      const w1full = (wByDate[key1] && wByDate[key1][0]) ? wByDate[key1][0] : (wVals[1] || "--");

      el("i0").textContent = iconFromText(w0full);
      el("s0").textContent = shortWx(w0full);
      el("d0").textContent = w0full;

      el("i1").textContent = iconFromText(w1full);
      el("s1").textContent = shortWx(w1full);
      el("d1").textContent = w1full;

      // è¡¨ç¤ºï¼šé™æ°´ç¢ºç‡ï¼ˆ4åŒºåˆ†ï¼‰
      const pops0 = (pByDate[key0] || []).map(x => (x === "" ? "--" : x));
      const pops1 = (pByDate[key1] || []).map(x => (x === "" ? "--" : x));

      const fmtPops = (arr) => {
        if (!arr || !arr.length) return "--";
        // 0-6/6-12/12-18/18-24 ã®4ã¤ã«æƒãˆã‚‹ï¼ˆè¶³ã‚Šãªã‘ã‚Œã°--ï¼‰
        const a = [arr[0], arr[1], arr[2], arr[3]].map(v => (v == null ? "--" : v));
        return a.join("/");
      };

      el("p0").textContent = fmtPops(pops0);
      el("p1").textContent = fmtPops(pops1);

      // è¡¨ç¤ºï¼šæœ€é«˜/æœ€ä½ï¼ˆãã®æ—¥ä»˜å†…ã® temps ã® max/min ã‚’ç®—å‡ºï¼‰
      const mm0 = maxMinFromTemps(tByDate[key0]);
      const mm1 = maxMinFromTemps(tByDate[key1]);

      const fmtMM = (mm) => {
        const a = (mm.max == null) ? "--" : String(mm.max);
        const b = (mm.min == null) ? "--" : String(mm.min);
        return `${a} / ${b} â„ƒ`;
      };

      el("t0").textContent = fmtMM(mm0);
      el("t1").textContent = fmtMM(mm1);

      // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰æ¶ˆã—ã¦OKï¼‰
      setDbg(`area=æ±äº¬åœ°æ–¹ / today=${key0} / tomo=${key1} / report=${(data.reportDatetime||"").slice(0,16)}`);

      // 30åˆ†ã”ã¨ã«æ›´æ–°ï¼ˆã‚µã‚¤ãƒãƒ¼ã‚¸å‘ã‘ï¼‰
      setTimeout(() => location.reload(), 30 * 60 * 1000);
    }

    main().catch(e => {
      setErr("è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ï¼š" + (e && e.message ? e.message : String(e)));
      // 1åˆ†å¾Œã«å†è©¦è¡Œ
      setTimeout(() => location.reload(), 60 * 1000);
    });
  </script>
</body>
</html>
