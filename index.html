<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1380, height=776, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>SkyTower Weather</title>

<style>
  html, body{
    width: 1380px;
    height: 776px;
    margin: 0;
    padding: 0;
    overflow: hidden;

    /* èƒŒæ™¯ï¼šæ¿ƒã„ãƒ–ãƒ«ãƒ¼ */
    background: #0b1b33; /* æ·±ã„ãƒã‚¤ãƒ“ãƒ¼ */
    color: #ffffff;

    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Yu Gothic", sans-serif;
  }

  #app{
    width: 1380px;
    height: 776px;
    box-sizing: border-box;
    padding: 26px 56px;
    display: grid;
    grid-template-rows: auto 1fr auto;
    gap: 16px;
  }

  .top{
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 16px;
  }

  .title{
    font-size: 40px;
    font-weight: 900;
    letter-spacing: 0.01em;
    line-height: 1.1;
    color: #ffffff;
  }

  .meta{
    font-size: 22px;
    font-weight: 700;
    opacity: 0.85;
    white-space: nowrap;
    color: #e5e7eb;
  }

  .cards{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    min-height: 0;
  }

  .card{
    border-radius: 22px;

    /* ã‚«ãƒ¼ãƒ‰ï¼šæ¿ƒã„ãƒ–ãƒ«ãƒ¼èƒŒæ™¯ã«é¦´æŸ“ã‚€ãƒ€ãƒ¼ã‚¯å¯„ã‚Š */
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.16);

    padding: 22px 24px;
    display: grid;
    grid-template-rows: auto auto auto auto 1fr;
    gap: 10px;
    min-height: 0;
  }

  .card h2{
    margin: 0;
    font-size: 46px;
    font-weight: 900;
    letter-spacing: 0.02em;
    color: #ffffff;
  }

  .wxline{
    display: flex;
    align-items: center;
    gap: 18px;
    min-height: 0;
    margin-top: 2px;
  }

  .icon{
    font-size: 220px;
    line-height: 1;
    width: 260px;
    text-align: center;
    flex: 0 0 260px;
    filter: drop-shadow(0 8px 14px rgba(0,0,0,0.25));
  }

  .wxtext{
    font-size: 84px;
    font-weight: 900;
    letter-spacing: 0.02em;
    line-height: 1.05;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 420px;
    color: #ffffff;
  }

  .wxdetail{
    font-size: 34px;
    font-weight: 800;
    opacity: 0.92;
    line-height: 1.22;
    color: #e5e7eb;

    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
    min-height: calc(34px * 1.22 * 2);
  }

  .grid{
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    align-content: start;
    margin-top: 2px;
  }

  .row{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 14px;
    font-size: 34px;
    line-height: 1.2;
  }

  .label{
    opacity: 0.85;
    font-weight: 800;
    color: #d1d5db;
  }

  .val{
    font-weight: 900;
    white-space: nowrap;
    text-align: right;
    flex: 0 0 auto;
    color: #ffffff;
  }

  .footer{
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    opacity: 0.8;
    white-space: nowrap;
    gap: 16px;
    color: #cbd5e1;
  }

  #dbg{
    font-size: 14px;
    opacity: 0.6;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 980px;
    color: #cbd5e1;
  }

  #err{
    color: #fecaca;
    font-weight: 800;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 420px;
  }

  *{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
</style>
</head>

<body>
  <div id="app">
    <div class="top">
      <div class="title">æ±äº¬ï¼ˆæ±Ÿæ±åŒºï¼‰å¤©æ°—</div>
      <div class="meta" id="pub">æ›´æ–°ï¼š--</div>
    </div>

    <div class="cards">
      <section class="card">
        <h2>ä»Šæ—¥</h2>
        <div class="wxline">
          <div class="icon" id="i0">--</div>
          <div class="wxtext" id="s0">--</div>
        </div>
        <div class="wxdetail" id="d0">--</div>
        <div class="grid">
          <div class="row"><span class="label">æœ€é«˜ / æœ€ä½</span><span class="val" id="t0">-- / -- â„ƒ</span></div>
          <div class="row"><span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span><span class="val" id="p0">--/--/--/--</span></div>
        </div>
      </section>

      <section class="card">
        <h2>æ˜æ—¥</h2>
        <div class="wxline">
          <div class="icon" id="i1">--</div>
          <div class="wxtext" id="s1">--</div>
        </div>
        <div class="wxdetail" id="d1">--</div>
        <div class="grid">
          <div class="row"><span class="label">æœ€é«˜ / æœ€ä½</span><span class="val" id="t1">-- / -- â„ƒ</span></div>
          <div class="row"><span class="label">é™æ°´ç¢ºç‡ï¼ˆ0-6/6-12/12-18/18-24ï¼‰</span><span class="val" id="p1">--/--/--/--</span></div>
        </div>
      </section>
    </div>

    <div class="footer">
      <div>å‡ºå…¸ï¼šæ°—è±¡åºï¼ˆforecast JSONï¼‰</div>
      <div id="dbg"></div>
      <div id="err"></div>
    </div>
  </div>

  <script>
    const URL_JMA = "https://www.jma.go.jp/bosai/forecast/data/forecast/130000.json";
    const el = (id) => document.getElementById(id);
    const setErr = (msg) => (el("err").textContent = msg || "");
    const setDbg = (msg) => (el("dbg").textContent = msg || "");

    const fmtDateKey = (iso) => iso ? String(iso).slice(0, 10) : "";

    // â˜…æ—¥ä»˜ã‚ºãƒ¬å¯¾ç­–ï¼šISOæ—¥ä»˜æ–‡å­—åˆ—ã‚’UTCã§åŠ ç®—ã—ã¦ã€"YYYY-MM-DD" ã‚’ä½œã‚‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰
    const addDays = (ymd, n) => {
      const [y,m,d] = ymd.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d));
      dt.setUTCDate(dt.getUTCDate() + n);
      return dt.toISOString().slice(0, 10);
    };

    const iconFromText = (t) => {
      const s = (t || "").toLowerCase();
      if (s.includes("é›·") || s.includes("ã‹ã¿ãªã‚Š") || s.includes("é›·é›¨")) return "â›ˆï¸";
      if (s.includes("é›ª") || s.includes("ã¿ãã‚Œ")) return "â„ï¸";
      if (s.includes("é›¨") || s.includes("ã‚ã‚")) return "ğŸŒ§ï¸";
      if (s.includes("æ™´") || s.includes("ã¯ã‚Œ")) return "â˜€ï¸";
      if (s.includes("ãã‚‚") || s.includes("æ›‡")) return "â˜ï¸";
      return "ğŸŒ¤ï¸";
    };

    const shortWx = (t) => {
      const s = (t || "").trim();
      const m = s.match(/^(æ™´ã‚Œ|ãã‚‚ã‚Š|æ›‡ã‚Š|é›¨|é›ª|é›·)/);
      if (m) return m[1].replace("æ›‡ã‚Š","ãã‚‚ã‚Š");
      return s.split(/[ ã€€]/).filter(Boolean)[0] || s || "--";
    };

    function pickAreaIndex(ts, preferName){
      if (!ts || !ts.areas) return 0;
      const a = ts.areas;
      const idx = a.findIndex(x => (x.area && x.area.name && x.area.name.includes(preferName)));
      return idx >= 0 ? idx : 0;
    }

    function buildByDate(times, values){
      const by = {};
      for (let i = 0; i < Math.min(times.length, values.length); i++){
        const k = fmtDateKey(times[i]);
        if (!k) continue;
        if (!by[k]) by[k] = [];
        by[k].push(values[i]);
      }
      return by;
    }

    function maxMinFromTemps(list){
      const nums = (list || []).map(x => Number(x)).filter(n => Number.isFinite(n));
      if (!nums.length) return {max:null, min:null};
      return {max: Math.max(...nums), min: Math.min(...nums)};
    }

    const fmtMM = (mm) => {
      const a = (mm.max == null) ? "--" : String(mm.max);
      const b = (mm.min == null) ? "--" : String(mm.min);
      return `${a} / ${b} â„ƒ`;
    };

    const fmtPops = (arr) => {
      const a = [arr?.[0], arr?.[1], arr?.[2], arr?.[3]].map(v => {
        if (v == null || v === "") return "--";
        return String(v);
      });
      return a.join("/");
    };

    async function main(){
      setErr("");
      setDbg("");

      const res = await fetch(URL_JMA, { cache: "no-store" });
      if (!res.ok) throw new Error("fetch failed: " + res.status);

      const json = await res.json();
      const data = Array.isArray(json) ? json[0] : json;
      if (!data || !data.timeSeries) throw new Error("unexpected JSON");

      const pub = data.reportDatetime || data.publicTime || "";
      el("pub").textContent = pub ? ("æ›´æ–°ï¼š" + pub.slice(0,16).replace("T"," ")) : "æ›´æ–°ï¼š--";

      const tsList = data.timeSeries || [];

      // å¤©æ°—
      const tsWeather = tsList.find(ts => ts.areas && ts.areas[0] && ts.areas[0].weathers) || tsList[0];
      const areaWeatherIdx = pickAreaIndex(tsWeather, "æ±äº¬åœ°æ–¹");
      const wTimes = (tsWeather.timeDefines || []);
      const wVals  = (tsWeather.areas?.[areaWeatherIdx]?.weathers) || [];
      const wByDate = buildByDate(wTimes, wVals);

      // é™æ°´ç¢ºç‡
      const tsPop = tsList.find(ts => ts.areas && ts.areas[0] && ts.areas[0].pops);
      const areaPopIdx = tsPop ? pickAreaIndex(tsPop, "æ±äº¬åœ°æ–¹") : 0;
      const pTimes = tsPop ? (tsPop.timeDefines || []) : [];
      const pVals  = tsPop ? (tsPop.areas?.[areaPopIdx]?.pops || []) : [];
      const pByDate = buildByDate(pTimes, pVals);

      // æ°—æ¸©
      const tsTemp = tsList.find(ts => ts.areas && ts.areas[0] && ts.areas[0].temps);
      const areaTempIdx = tsTemp ? pickAreaIndex(tsTemp, "æ±äº¬åœ°æ–¹") : 0;
      const tTimes = tsTemp ? (tsTemp.timeDefines || []) : [];
      const tVals  = tsTemp ? (tsTemp.areas?.[areaTempIdx]?.temps || []) : [];
      const tByDate = buildByDate(tTimes, tVals);

      // â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼štoday/tomo ã‚’JSTã§ã‚ºãƒ©ã•ãªã„ï¼ˆtoISOStringã¯ä½¿ã‚ãªã„ï¼‰
      const baseKey =
        fmtDateKey(data.reportDatetime) ||
        fmtDateKey(wTimes[0]) ||
        fmtDateKey(pTimes[0]) ||
        fmtDateKey(tTimes[0]);

      if (!baseKey) throw new Error("date key not found");
      const key0 = baseKey;
      const key1 = addDays(baseKey, 1);

      // å¤©æ°—è¡¨ç¤º
      const w0full = (wByDate[key0]?.[0]) ?? (wVals[0] ?? "--");
      const w1full = (wByDate[key1]?.[0]) ?? (wVals[1] ?? "--");

      el("i0").textContent = iconFromText(w0full);
      el("s0").textContent = shortWx(w0full);
      el("d0").textContent = w0full;

      el("i1").textContent = iconFromText(w1full);
      el("s1").textContent = shortWx(w1full);
      el("d1").textContent = w1full;

      // é™æ°´ç¢ºç‡ï¼ˆ4åŒºåˆ†ï¼‰
      el("p0").textContent = fmtPops(pByDate[key0]);
      el("p1").textContent = fmtPops(pByDate[key1]);

      // æœ€é«˜/æœ€ä½ï¼ˆãã®æ—¥ã®tempsã‹ã‚‰max/minï¼‰
      el("t0").textContent = fmtMM(maxMinFromTemps(tByDate[key0]));
      el("t1").textContent = fmtMM(maxMinFromTemps(tByDate[key1]));

      setDbg(`area=æ±äº¬åœ°æ–¹ / today=${key0} / tomo=${key1} / report=${(data.reportDatetime||"").slice(0,16)}`);

      setTimeout(() => location.reload(), 30 * 60 * 1000);
    }

    main().catch(e => {
      setErr("è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ï¼š" + (e?.message || String(e)));
      setTimeout(() => location.reload(), 60 * 1000);
    });
  </script>
</body>
</html>
